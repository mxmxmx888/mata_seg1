{% extends "base/base_app.html" %}
{% load static %}

{% block content %}
<main class="recipi-home">
  <div class="container-fluid px-4 px-xl-5 py-4">

    {% if has_search %}

      <div class="row justify-content-center mb-4">
        <div class="col-auto">
          <ul class="nav nav-pills recipi-toggle" id="searchScopeTabs" role="tablist">

            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'recipes' %}active{% endif %}"
                href="?mode=search&scope=recipes&q={{ search_query|urlencode }}&category={{ category|urlencode }}&ingredient={{ ingredient|urlencode }}&sort={{ sort|urlencode }}&have_ingredients={{ have_ingredients|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'recipes' %}true{% else %}false{% endif %}"
              >
                Recipes
              </a>
            </li>

            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'users' %}active{% endif %}"
                href="?mode=search&scope=users&q={{ search_query|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'users' %}true{% else %}false{% endif %}"
              >
                Users
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'shopping' %}active{% endif %}"
                href="?mode=search&scope=shopping&q={{ search_query|urlencode }}&category={{ category|urlencode }}&ingredient={{ ingredient|urlencode }}&sort={{ sort|urlencode }}&have_ingredients={{ have_ingredients|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'shopping' %}true{% else %}false{% endif %}"
              >
                Products
              </a>
            </li>

          </ul>
        </div>
      </div>

      {% if scope == "recipes" %}
        {% include "partials/dashboard/recipe_filters.html" %}
      {% endif %}

      {% if scope == "users" %}
        {% if users_results %}
          <div class="user-search-grid">
            {% for u in users_results %}
              <a
                href="{% url 'profile' %}?user={{ u.username }}"
                class="user-search-card text-decoration-none"
                aria-label="{{ u.get_full_name|default:u.username }}"
              >
                <div class="user-search-avatar {% if not u.mini_avatar_url %}is-placeholder{% endif %}">
                  {% if u.mini_avatar_url %}
                    <img src="{{ u.mini_avatar_url }}" alt="{{ u.username }} avatar" loading="lazy">
                  {% else %}
                    <span aria-hidden="true">{{ u.username|first|upper }}</span>
                    <span class="visually-hidden">{{ u.username }} avatar placeholder</span>
                  {% endif %}
                </div>
                <div class="user-search-name">{{ u.get_full_name|default:u.username }}</div>
                <div class="user-search-handle">{{ u.username }}</div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5 dashboard-empty-state">
            No users found for this search.
          </div>
        {% endif %}
      {% elif scope == "shopping" %}
        {% if shopping_items %}
          <div
            class="shop-masonry"
            id="shopping-grid"
            data-page="{{ shopping_page_number|default:1 }}"
          >
            {% include "partials/shop/shop_items.html" with items=shopping_items %}
          </div>
          <div id="shopping-loading" class="shop-loading d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading more items…
          </div>
          <div id="shopping-sentinel" aria-hidden="true"></div>
        {% else %}
          <div class="text-center py-5 dashboard-empty-state">
            No shop items found for this search.
          </div>
        {% endif %}
      {% else %}
        {% if popular_recipes %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=popular_recipes grid_id="discover-grid" %}
        {% else %}
          <div class="text-center py-5 dashboard-empty-state">
            {% if have_ingredients %}
              No recipes found using only these ingredients.
            {% else %}
              No recipes found for this search.
            {% endif %}
          </div>
        {% endif %}
      {% endif %}

    {% else %}

      <div class="row justify-content-center mb-4">
        <div class="col-auto">
          <ul class="nav nav-pills recipi-toggle" id="recipiFeedTabs" role="tablist">

            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="forYou-tab"
                data-bs-toggle="pill"
                data-bs-target="#forYou"
                type="button"
                role="tab"
                aria-selected="true"
              >
                For you
              </button>
            </li>

            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="following-tab"
                data-bs-toggle="pill"
                data-bs-target="#following"
                type="button"
                role="tab"
                aria-selected="false"
              >
                Following
              </button>
            </li>

          </ul>
        </div>
      </div>

      {% include "partials/dashboard/recipe_filters.html" %}

      <div class="tab-content">

      <div class="tab-pane fade show active" id="forYou" role="tabpanel" aria-labelledby="forYou-tab">
        {% if for_you_posts %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=for_you_posts grid_id="forYou-grid" %}
          <div id="forYou-loading" class="text-center py-3 d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading more recipes…
          </div>
          <div id="forYou-sentinel" aria-hidden="true"></div>
        {% else %}
          <div class="text-center py-5 dashboard-empty-state">
            Nothing here yet — your personalised feed will appear here soon.
          </div>
        {% endif %}
      </div>

      <div class="tab-pane fade" id="following" role="tabpanel" aria-labelledby="following-tab">
        {% if following_posts %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=following_posts grid_id="following-grid" %}
          <div id="following-loading" class="text-center py-3 d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading more recipes…
          </div>
          <div id="following-sentinel" aria-hidden="true"></div>
        {% else %}
          <div class="text-center py-5 dashboard-empty-state">
            Follow some cullinarians to get started!
          </div>
        {% endif %}
      </div>

      </div>

    {% endif %}

  </div>
</main>

<script src="{% static 'js/infinite_list.js' %}" defer></script>
{% include "partials/dashboard/discover_infinite_scroll.html" %}
{% include "partials/dashboard/for_you_infinite_scroll.html" %}
{% include "partials/dashboard/following_infinite_scroll.html" %}
{% include "partials/dashboard/shopping_infinite_scroll.html" %}
<script src="{% static 'js/dashboard_scroll.js' %}" defer></script>

{% endblock %}
