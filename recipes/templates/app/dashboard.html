{% extends "base/base_app.html" %}
{% load static %}

{% block content %}
<main class="recipi-home">
  <div class="container-fluid px-4 px-xl-5 py-4">

    {% if has_search %}

      <div class="row justify-content-center mb-4">
        <div class="col-auto">
          <ul class="nav nav-pills recipi-toggle" id="searchScopeTabs" role="tablist">

            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'recipes' %}active{% endif %}"
                href="?mode=search&scope=recipes&q={{ search_query|urlencode }}&category={{ category|urlencode }}&ingredient={{ ingredient|urlencode }}&sort={{ sort|urlencode }}&have_ingredients={{ have_ingredients|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'recipes' %}true{% else %}false{% endif %}"
              >
                Recipes
              </a>
            </li>

            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'users' %}active{% endif %}"
                href="?mode=search&scope=users&q={{ search_query|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'users' %}true{% else %}false{% endif %}"
              >
                Users
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a
                class="nav-link {% if scope == 'shopping' %}active{% endif %}"
                href="?mode=search&scope=shopping&q={{ search_query|urlencode }}&category={{ category|urlencode }}&ingredient={{ ingredient|urlencode }}&sort={{ sort|urlencode }}&have_ingredients={{ have_ingredients|urlencode }}"
                role="tab"
                aria-selected="{% if scope == 'shopping' %}true{% else %}false{% endif %}"
              >
                Products
              </a>
            </li>

          </ul>
        </div>
      </div>

      {% if scope == "recipes" %}
        <form method="get" class="mb-4 d-flex align-items-center justify-content-center dashboard-filters">
          <input type="hidden" name="mode" value="search">
          <input type="hidden" name="scope" value="recipes">

          <select
            name="category"
            class="form-select dashboard-filter-select"
            onchange="this.form.submit()"
          >
            <option value="all"{% if not category or category == "all" %} selected{% endif %}>
              All categories
            </option>
            <option value="breakfast"{% if category == "breakfast" %} selected{% endif %}>Breakfast</option>
            <option value="lunch"{% if category == "lunch" %} selected{% endif %}>Lunch</option>
            <option value="dinner"{% if category == "dinner" %} selected{% endif %}>Dinner</option>
            <option value="dessert"{% if category == "dessert" %} selected{% endif %}>Dessert</option>
            <option value="vegan"{% if category == "vegan" %} selected{% endif %}>Vegan</option>
          </select>

          <input
            type="text"
            name="ingredient"
            class="form-control dashboard-filter-input"
            placeholder="Filter by ingredient (e.g. chicken)"
            value="{{ ingredient|default:'' }}"
          >

          <select
            name="sort"
            class="form-select dashboard-filter-select"
            onchange="this.form.submit()"
          >
            <option value="newest"{% if not sort or sort == "newest" %} selected{% endif %}>
              Newest
            </option>
            <option value="popular"{% if sort == "popular" %} selected{% endif %}>
              Most popular
            </option>
            <option value="oldest"{% if sort == "oldest" %} selected{% endif %}>
              Oldest
            </option>
          </select>

          <div class="d-flex align-items-center gap-2 dashboard-have-ingredients">
            <input
              type="text"
              name="have_ingredients"
              class="form-control dashboard-filter-input"
              placeholder="Only recipes using (e.g. cheese, bread)"
              value="{{ have_ingredients|default:'' }}"
            >
            <button type="submit" class="btn btn-outline-light btn-sm rounded-pill">
              Apply
            </button>
          </div>

        </form>
      {% endif %}

      {% if scope == "users" %}
        {% if users_results %}
          <div class="user-search-grid">
            {% for u in users_results %}
              <a
                href="{% url 'profile' %}?user={{ u.username }}"
                class="user-search-card text-decoration-none"
                aria-label="{{ u.get_full_name|default:u.username }}"
              >
                <div class="user-search-avatar {% if not u.mini_avatar_url %}is-placeholder{% endif %}">
                  {% if u.mini_avatar_url %}
                    <img src="{{ u.mini_avatar_url }}" alt="{{ u.username }} avatar" loading="lazy">
                  {% else %}
                    <span aria-hidden="true">{{ u.username|first|upper }}</span>
                    <span class="visually-hidden">{{ u.username }} avatar placeholder</span>
                  {% endif %}
                </div>
                <div class="user-search-name">{{ u.get_full_name|default:u.username }}</div>
                <div class="user-search-handle">{{ u.username }}</div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5" style="color: #8b8c9a;">
            No users found for this search.
          </div>
        {% endif %}
      {% elif scope == "shopping" %}
        {% if shopping_items %}
          <div
            class="shop-masonry"
            id="shopping-grid"
            data-page="{{ shopping_page_number|default:1 }}"
          >
            {% include "partials/shop/shop_items.html" with items=shopping_items %}
          </div>
          <div id="shopping-loading" class="shop-loading d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading more items…
          </div>
          <div id="shopping-sentinel" aria-hidden="true"></div>
        {% else %}
          <div class="text-center py-5" style="color: #8b8c9a;">
            No shop items found for this search.
          </div>
        {% endif %}
      {% else %}
        {% if popular_recipes %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=popular_recipes grid_id="discover-grid" %}
        {% else %}
          <div class="text-center py-5" style="color: #8b8c9a;">
            {% if have_ingredients %}
              No recipes found using only these ingredients.
            {% else %}
              No recipes found for this search.
            {% endif %}
          </div>
        {% endif %}
      {% endif %}

    {% else %}

      <div class="row justify-content-center mb-4">
        <div class="col-auto">
          <ul class="nav nav-pills recipi-toggle" id="recipiFeedTabs" role="tablist">

            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="forYou-tab"
                data-bs-toggle="pill"
                data-bs-target="#forYou"
                type="button"
                role="tab"
                aria-selected="true"
              >
                For you
              </button>
            </li>

            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="following-tab"
                data-bs-toggle="pill"
                data-bs-target="#following"
                type="button"
                role="tab"
                aria-selected="false"
              >
                Following
              </button>
            </li>

          </ul>
        </div>
      </div>

      <form method="get" class="mb-4 d-flex align-items-center justify-content-center dashboard-filters">
        <input type="hidden" name="mode" value="search">
        <input type="hidden" name="scope" value="recipes">

        <select
          name="category"
          class="form-select dashboard-filter-select"
          onchange="this.form.submit()"
        >
          <option value="all"{% if not category or category == "all" %} selected{% endif %}>
            All categories
          </option>
          <option value="breakfast"{% if category == "breakfast" %} selected{% endif %}>Breakfast</option>
          <option value="lunch"{% if category == "lunch" %} selected{% endif %}>Lunch</option>
          <option value="dinner"{% if category == "dinner" %} selected{% endif %}>Dinner</option>
          <option value="dessert"{% if category == "dessert" %} selected{% endif %}>Dessert</option>
          <option value="vegan"{% if category == "vegan" %} selected{% endif %}>Vegan</option>
        </select>

        <input
          type="text"
          name="ingredient"
          class="form-control dashboard-filter-input"
          placeholder="Filter by ingredient (e.g. chicken)"
          value="{{ ingredient|default:'' }}"
        >

        <select
          name="sort"
          class="form-select dashboard-filter-select"
          onchange="this.form.submit()"
        >
          <option value="newest"{% if not sort or sort == "newest" %} selected{% endif %}>
            Newest
          </option>
          <option value="popular"{% if sort == "popular" %} selected{% endif %}>
            Most popular
          </option>
          <option value="oldest"{% if sort == "oldest" %} selected{% endif %}>
            Oldest
          </option>
        </select>

        <div class="d-flex align-items-center gap-2 dashboard-have-ingredients">
          <input
            type="text"
            name="have_ingredients"
            class="form-control dashboard-filter-input"
            placeholder="Only recipes using (e.g. cheese, bread)"
            value="{{ have_ingredients|default:'' }}"
          >
          <button type="submit" class="btn btn-outline-light btn-sm rounded-pill">
            Apply
          </button>
        </div>

      </form>

      <div class="tab-content">

      <div class="tab-pane fade show active" id="forYou" role="tabpanel" aria-labelledby="forYou-tab">
        {% if for_you_posts %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=for_you_posts grid_id="forYou-grid" %}
        {% else %}
          <div class="text-center py-5" style="color: #8b8c9a;">
            Nothing here yet — your personalised feed will appear here soon.
          </div>
        {% endif %}
      </div>

      <div class="tab-pane fade" id="following" role="tabpanel" aria-labelledby="following-tab">
        {% if following_posts %}
          {% include "partials/feed/feed_masonry_grid.html" with posts=following_posts %}
        {% else %}
          <div class="text-center py-5" style="color: #8b8c9a;">
            Follow some cullinarians to get started!
          </div>
        {% endif %}
      </div>

      </div>

    {% endif %}

  </div>
</main>

{% if has_search and popular_has_next %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('discover-grid');
    if (!container) return;

    const columns = Array.from(
      container.querySelectorAll('.feed-masonry-column')
    );
    if (!columns.length) return;

    let page = 1;
    let loading = false;
    let hasNext = {{ popular_has_next|yesno:"true,false" }};

    function appendHtmlToColumns(html) {
      if (!html) return;
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const cards = Array.from(
        temp.querySelectorAll('.my-recipe-card')
      );

      cards.forEach(function (card) {
        let target = columns[0];
        for (let i = 1; i < columns.length; i += 1) {
          if (columns[i].offsetHeight < target.offsetHeight) {
            target = columns[i];
          }
        }
        target.appendChild(card);
      });
    }

    function loadMoreDiscover() {
      if (loading || !hasNext) return;
      loading = true;

      page += 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', String(page));
      url.searchParams.set('ajax', '1');

      fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function (data) {
          if (data && data.html) {
            appendHtmlToColumns(data.html);
          }
          hasNext = Boolean(data && data.has_next);
          loading = false;
        })
        .catch(function () {
          loading = false;
        });
    }

    window.addEventListener('scroll', function () {
      if (loading || !hasNext) return;

      const scrollPosition = window.innerHeight + window.scrollY;
      const threshold = document.body.offsetHeight - 300;

      if (scrollPosition >= threshold) {
        loadMoreDiscover();
      }
    });
  });
</script>
{% endif %}

{% if has_search and scope == "shopping" %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('shopping-grid');
    const sentinel = document.getElementById('shopping-sentinel');
    const loadingEl = document.getElementById('shopping-loading');
    if (!container || !sentinel) return;

    const breakpoints = [
      { width: 1600, count: 6 },
      { width: 1400, count: 5 },
      { width: 1200, count: 4 },
      { width: 992, count: 3 },
      { width: 768, count: 3 },
      { width: 520, count: 2 },
      { width: 0, count: 2 },
    ];

    function getColumnCount() {
      const w = window.innerWidth;
      for (let i = 0; i < breakpoints.length; i += 1) {
        if (w >= breakpoints[i].width) return breakpoints[i].count;
      }
      return 2;
    }

    let columns = [];

    function placeItems(nodes) {
      if (!nodes || !nodes.length) return;
      nodes.forEach(function (node) {
        let target = columns[0];
        for (let i = 1; i < columns.length; i += 1) {
          if (columns[i].offsetHeight < target.offsetHeight) {
            target = columns[i];
          }
        }
        target.appendChild(node);
      });
    }

    function buildColumns() {
      const desiredCount = getColumnCount();
      if (columns.length === desiredCount) return;

      const cards = Array.from(
        container.querySelectorAll('.shop-masonry-item')
      );
      container.innerHTML = '';
      columns = [];
      for (let i = 0; i < desiredCount; i += 1) {
        const col = document.createElement('div');
        col.className = 'shop-column';
        container.appendChild(col);
        columns.push(col);
      }
      placeItems(cards);
    }

    let page = Number(container.dataset.page || '1');
    let loading = false;
    let hasNext = {{ shopping_has_next|yesno:"true,false" }};

    function setLoading(state) {
      loading = state;
      if (!loadingEl) return;
      if (state) {
        loadingEl.classList.remove('d-none');
      } else {
        loadingEl.classList.add('d-none');
      }
    }

    function appendHtml(html) {
      if (!html) return;
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const items = Array.from(temp.children);
      placeItems(items);
    }

    function loadMoreShopping() {
      if (loading || !hasNext) return;
      setLoading(true);

      page += 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', String(page));
      url.searchParams.set('ajax', '1');

      fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function (data) {
          if (data && data.html) appendHtml(data.html);
          hasNext = Boolean(data && data.has_next);
          if (!hasNext && observer) {
            observer.disconnect();
          }
          setLoading(false);
        })
        .catch(function () {
          page -= 1;
          setLoading(false);
        });
    }

    const observer = 'IntersectionObserver' in window
      ? new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              loadMoreShopping();
            }
          });
        }, { rootMargin: '600px 0px' })
      : null;

    if (observer) {
      observer.observe(sentinel);
    } else {
      window.addEventListener('scroll', function () {
        if (loading || !hasNext) return;
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 300;
        if (scrollPosition >= threshold) {
          loadMoreShopping();
        }
      });
    }

    buildColumns();
    window.addEventListener('resize', buildColumns);
  });
</script>
{% endif %}

{% endblock %}
