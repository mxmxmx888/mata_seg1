{% extends "base/base_app.html" %}

{% block body_class %}shop-body{% endblock %}

{% block content %}

<main class="shop-shell container">
  {% if items %}
    <div
      class="shop-masonry"
      id="shop-items-container"
      data-page="{{ page_obj.number }}"
      data-seed="{{ seed }}"
    >
      {% include 'partials/shop/shop_items.html' with items=items %}
    </div>
    <div id="shop-loading" class="shop-loading d-none">
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      Loading more itemsâ€¦
    </div>
    <div id="shop-sentinel" aria-hidden="true"></div>
  {% else %}
    <div class="shop-empty text-center py-5" id="shop-items-container">
      <div class="mb-3 text-muted display-5"><i class="bi bi-bag"></i></div>
      <h3 class="mb-2">Nothing in the shop yet</h3>
      <p class="text-muted mb-4">Add items with shop links to your recipes to see them here.</p>
      <a href="{% url 'recipe_create' %}" class="btn btn-dark rounded-pill px-4">Create a Recipe</a>
    </div>
  {% endif %}
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('shop-items-container');
    const sentinel = document.getElementById('shop-sentinel');
    const loadingEl = document.getElementById('shop-loading');
    const seed = (container && container.dataset.seed) || '{{ seed }}';
    if (!container || !sentinel) return;

    const breakpoints = [
      { width: 1600, count: 6 },
      { width: 1400, count: 5 },
      { width: 1200, count: 4 },
      { width: 992, count: 3 },
      { width: 768, count: 3 },
      { width: 520, count: 2 },
      { width: 0, count: 2 },
    ];

    function getColumnCount() {
      const w = window.innerWidth;
      for (const bp of breakpoints) {
        if (w >= bp.width) return bp.count;
      }
      return 2;
    }

    let columns = [];

    function buildColumns(force) {
      const desiredCount = getColumnCount();
      const cards = Array.from(container.querySelectorAll('.shop-masonry-item'));
      if (!force && columns.length === desiredCount) return;

      container.innerHTML = '';
      columns = [];
      for (let i = 0; i < desiredCount; i += 1) {
        const col = document.createElement('div');
        col.className = 'shop-column';
        container.appendChild(col);
        columns.push(col);
      }
      placeItems(cards);
    }

    function shortestColumn() {
      let target = columns[0];
      for (let i = 1; i < columns.length; i += 1) {
        if (columns[i].offsetHeight < target.offsetHeight) {
          target = columns[i];
        }
      }
      return target;
    }

    function placeItems(nodes) {
      if (!nodes || !nodes.length) return;
      nodes.forEach(function (node) {
        const target = shortestColumn();
        target.appendChild(node);
      });
    }

    function waitForImages(nodes) {
      const imgs = [];
      nodes.forEach(function (node) {
        imgs.push.apply(imgs, node.querySelectorAll('img'));
      });
      if (!imgs.length) return Promise.resolve();
      return new Promise(function (resolve) {
        let done = 0;
        const finish = function () {
          done += 1;
          if (done >= imgs.length) resolve();
        };
        imgs.forEach(function (img) {
          if (img.complete) {
            finish();
          } else {
            img.addEventListener('load', finish, { once: true });
            img.addEventListener('error', finish, { once: true });
          }
        });
      });
    }

    let page = Number(container.dataset.page || '1');
    let loading = false;
    let hasNext = {{ page_obj.has_next|yesno:"true,false" }};

    function setLoading(state) {
      loading = state;
      if (!loadingEl) return;
      if (state) {
        loadingEl.classList.remove('d-none');
      } else {
        loadingEl.classList.add('d-none');
      }
    }

    function appendHtml(html) {
      if (!html) return Promise.resolve();
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const items = Array.from(temp.children);
      return Promise.resolve().then(function () {
        placeItems(items);
        waitForImages(items).then(function () {
          items.forEach(function (node) {
            if (node.parentElement) node.remove();
          });
          placeItems(items);
        });
      });
    }

    function loadMoreShopItems() {
      if (loading || !hasNext) return;
      setLoading(true);

      page += 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', String(page));
      if (seed) url.searchParams.set('seed', seed);
      url.searchParams.set('ajax', '1');

      fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function (data) {
          return appendHtml(data && data.html).then(function () {
            hasNext = Boolean(data && data.has_next);
            if (!hasNext && observer) {
              observer.disconnect();
            }
          });
        })
        .catch(function () {
          page -= 1;
        })
        .finally(function () {
          setLoading(false);
        });
    }

    const observer = 'IntersectionObserver' in window
      ? new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              loadMoreShopItems();
            }
          });
        }, { rootMargin: '600px 0px' })
      : null;

    if (observer) {
      observer.observe(sentinel);
    } else {
      window.addEventListener('scroll', function () {
        if (loading || !hasNext) return;
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 300;
        if (scrollPosition >= threshold) {
          loadMoreShopItems();
        }
      });
    }

    const initialItems = Array.from(container.querySelectorAll('.shop-masonry-item'));
    buildColumns();
    waitForImages(initialItems).then(function () {
      buildColumns(true);
    });
    window.addEventListener('resize', function () {
      buildColumns(true);
    });
  });
</script>
{% endblock %}
