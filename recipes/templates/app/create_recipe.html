{# recipes/templates/app/create_recipe.html #}
{% extends "base/base_app.html" %}
{% load static widget_tweaks %}

{% block content %}
  <main class="app-page">
    <div class="container-lg">

      <div class="create-recipe-card">
        <h1 class="hero-title create-recipe-title">Create a recipe</h1>
        <p class="hero-lead create-recipe-lead">
          Give it a title, a short description, then list ingredients and steps.
        </p>

        <form method="post" enctype="multipart/form-data" data-form-bound="{{ form.is_bound|yesno:'true,false' }}" data-form-has-errors="{% if form.errors %}true{% else %}false{% endif %}" novalidate>
          {% csrf_token %}

          {% include "partials/forms/bootstrap_form.html" with form=form exclude_fields=exclude_fields %}

          <div class="shopping-links-helper mt-5 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-1 shopping-links-title text-dark">Shopping links</h5>
                <p class="text-muted small mb-0">Add items with links to appear in the shop section.</p>
              </div>
              <span class="text-secondary small fw-semibold">Optional</span>
            </div>

            <div class="row g-3 align-items-end shopping-links-row">
              <div class="col-12 col-md-5 col-lg-5 shopping-links-field">
                <label for="shop-item" class="form-label mb-1 text-muted small">Item Name</label>
                <input type="text" id="shop-item" class="form-control form-control-dark" placeholder="e.g. Matcha Powder">
              </div>
              <div class="col-12 col-md-5 col-lg-5 shopping-links-field">
                <label for="shop-link" class="form-label mb-1 text-muted small">Online Link</label>
                <input type="url" id="shop-link" class="form-control form-control-dark" placeholder="https://...">
              </div>
            </div>

            <div class="shopping-links-upload mt-3">
              <label class="form-label mb-1 text-muted small" for="{{ form.shop_images.id_for_label }}">Shopping images</label>
              {% if form.shop_images.errors %}
                {% render_field form.shop_images class="form-control form-control-dark shopping-upload-input is-invalid" %}
              {% else %}
                {% render_field form.shop_images class="form-control form-control-dark shopping-upload-input" %}
              {% endif %}
              <small class="text-muted small d-block mt-1"></small>
              {% if form.shop_images.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.shop_images.errors }}
                </div>
              {% endif %}
              <div id="shop-image-file-list" class="small text-muted mt-2"></div>
            </div>

            <div class="col-12 mt-3">
              <button type="button" id="add-shop-link" class="btn btn-white shop-add-btn">Add</button>
            </div>

            <div class="mt-4 shopping-links-list">
              <div class="small fw-bold text-muted mb-2 text-uppercase tracking-wide">Added Items</div>
              <div id="shop-list" class="shopping-list-box text-secondary small">No shopping links added yet.</div>
            </div>
          </div>

          <div class="small text-muted mb-2 mt-4">
            Tip: add tags like <code>#food</code>, <code>#dinner</code>, or <code>#private</code> in the tags field to control how your recipes are discovered.
          </div>

          <div class="mt-3 text-center">
            <button type="submit" class="btn-save-recipe">
              Post recipe
            </button>
          </div>
        </form>
      </div>

  </div>
  </main>

  <script>
    (function() {
      const formEl = document.querySelector('.create-recipe-card form');
      const imageInput = document.getElementById('id_images');
      const imageList = document.getElementById('image-file-list');
      const shopImageInput = document.getElementById('id_shop_images');
      const shopImageList = document.getElementById('shop-image-file-list');
      const shoppingField = document.getElementById('id_shopping_links_text');
      const isBound = formEl && formEl.dataset.formBound === 'true';
      const hasErrors = formEl && formEl.dataset.formHasErrors === 'true';
      const requiredFields = formEl ? Array.from(formEl.querySelectorAll('[required]')) : [];
      const IMG_STORAGE_KEY = 'create-recipe-images';
      
      const ingredientsField = document.getElementById('id_ingredients_text');
      const itemInput = document.getElementById('shop-item');
      const linkInput = document.getElementById('shop-link');
      const addBtn = document.getElementById('add-shop-link');
      const listBox = document.getElementById('shop-list');
      const shoppingList = [];
      const shopImageFiles = [];

      if (!formEl || !ingredientsField || !itemInput || !linkInput || !addBtn || !listBox || !shoppingField) return;

      if (imageInput) {
        imageInput.setAttribute('required', 'required');
        requiredFields.push(imageInput);
      }

      function clearFieldError(field) {
        const container = field.closest('.mb-3') || field.parentElement;
        if (!container) return;
        container.querySelectorAll('.client-required-error').forEach((msg) => msg.remove());
      }

      function renderRequiredFieldErrors() {
        let hasClientErrors = false;
        formEl.querySelectorAll('.client-required-error').forEach((msg) => msg.remove());
        requiredFields.forEach((field) => {
          const isMissing = field.validity ? field.validity.valueMissing : !(field.value || '').trim();
          if (!isMissing) {
            clearFieldError(field);
            return;
          }
          hasClientErrors = true;
          const message = document.createElement('div');
          message.className = 'client-required-error';
          message.textContent = 'field required';
          const container = field.closest('.mb-3') || field.parentElement;
          const invalidFeedback = container ? container.querySelector('.invalid-feedback') : null;
          if (invalidFeedback) {
            invalidFeedback.insertAdjacentElement('beforebegin', message);
          } else if (container) {
            container.appendChild(message);
          } else {
            field.insertAdjacentElement('afterend', message);
          }
        });
        return hasClientErrors;
      }

      requiredFields.forEach((field) => {
        field.addEventListener('input', () => clearFieldError(field));
        field.addEventListener('change', () => clearFieldError(field));
      });

      function renderImagesList() {
        if (!imageInput || !imageList) return;
        const files = imageInput.files;
        if (!files || !files.length) {
          imageList.textContent = "";
          return;
        }
        const names = Array.from(files).map(f => f.name);
        imageList.textContent = names.join(", ");
      }
      if (imageInput) {
        imageInput.addEventListener('change', () => {
          renderImagesList();
          persistFiles(imageInput, IMG_STORAGE_KEY);
        });
      }

      function renderShopImagesList() {
        if (!shopImageList) return;
        if (!shopImageFiles.length) {
          shopImageList.textContent = "";
          return;
        }
        const names = shopImageFiles.filter(Boolean).map(f => f.name);
        shopImageList.textContent = names.join(", ");
      }
      if (shopImageInput) {
        shopImageInput.multiple = false;
        shopImageInput.addEventListener('change', renderShopImagesList);
      }

      function syncShopImagesInput() {
        if (!shopImageInput || typeof DataTransfer === 'undefined') return;
        const dt = new DataTransfer();
        shopImageFiles.forEach(f => {
          if (f) dt.items.add(f);
        });
        shopImageInput.files = dt.files;
        renderShopImagesList();
      }

      function normalizeUrl(url) {
        if (!url) return '';
        return /^https?:\/\//i.test(url) ? url : 'https://' + url;
      }

      function syncShoppingField() {
        if (!shoppingField) return;
        shoppingField.value = shoppingList.map(item => item.url ? `${item.name} | ${item.url}` : item.name).join('\n');
      }

      function renderList() {
        if (!shoppingList.length) {
          listBox.innerHTML = '<div class="text-secondary small fst-italic">No shopping links added yet.</div>';
          syncShoppingField();
          return;
        }
        listBox.innerHTML = shoppingList.map((item, idx) => `
          <div class="shopping-list-item" data-idx="${idx}">
            <div class="d-flex align-items-center gap-2">
              ${item.previewUrl ? `<img src="${item.previewUrl}" alt="${item.name}" class="shopping-thumb">` : ''}
              <span class="fw-medium">${item.name}</span>
              <span class="note">${item.url ? '<i class="bi bi-link-45deg"></i> Linked' : ''}</span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger remove py-0 px-2" data-idx="${idx}">Remove</button>
          </div>
        `).join('');

        listBox.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', () => {
            const i = parseInt(btn.dataset.idx, 10);
            const removed = shoppingList.splice(i, 1)[0];
            const removedFile = shopImageFiles.splice(i, 1)[0];
            if (removed && removed.previewUrl) {
              URL.revokeObjectURL(removed.previewUrl);
            }
            syncShopImagesInput();
            renderList();
          });
        });

        syncShoppingField();
      }

      function showShoppingError(field, message) {
        if (!field) return;
        const container = field.closest('.shopping-links-field') || field.closest('.shopping-links-upload') || field.parentElement;
        if (!container) return;
        let msg = container.querySelector('.client-required-error');
        if (!msg) {
          msg = document.createElement('div');
          msg.className = 'client-required-error';
          container.appendChild(msg);
        }
        msg.textContent = message;
      }

      function clearShoppingError(field) {
        if (!field) return;
        const container = field.closest('.shopping-links-field') || field.closest('.shopping-links-upload') || field.parentElement;
        if (!container) return;
        container.querySelectorAll('.client-required-error').forEach((el) => el.remove());
      }

      [itemInput, linkInput, shopImageInput].forEach((el) => {
        if (!el) return;
        el.addEventListener('input', () => clearShoppingError(el));
        el.addEventListener('change', () => clearShoppingError(el));
      });

      function addLink() {
        const name = (itemInput.value || '').trim();
        const rawUrl = (linkInput.value || '').trim();
        const files = shopImageInput && shopImageInput.files ? Array.from(shopImageInput.files) : [];
        let hasMissing = false;

        clearShoppingError(itemInput);
        clearShoppingError(linkInput);
        clearShoppingError(shopImageInput);

        if (!name) {
          showShoppingError(itemInput, 'Please add an item name.');
          hasMissing = true;
        }
        if (!rawUrl) {
          showShoppingError(linkInput, 'Please add an online link.');
          hasMissing = true;
        }
        if (!files.length) {
          showShoppingError(shopImageInput, 'Please choose an image for this item.');
          hasMissing = true;
        }
        if (hasMissing) {
          if (!name) itemInput.focus();
          else if (!rawUrl) linkInput.focus();
          else if (!files.length && shopImageInput) shopImageInput.focus();
          return;
        }

        const file = files[0];
        const previewUrl = URL.createObjectURL(file);
        shoppingList.push({ name, url: normalizeUrl(rawUrl), previewUrl });
        shopImageFiles.push(file);
        syncShopImagesInput();
        renderList();

        itemInput.value = '';
        linkInput.value = '';
        if (shopImageInput) {
          shopImageInput.value = '';
          renderShopImagesList();
        }
        itemInput.focus();
      }

      function cleanIngredientsField() {
        const manual = (ingredientsField.value || '').trim();
        const manualLines = manual ? manual.split(/\r?\n/).map(l => l.trim()).filter(Boolean) : [];
        ingredientsField.value = manualLines.join('\n');
      }

      function persistFiles(input, storageKey) {
        if (!input || !storageKey) return;
        const files = input.files;
        if (!files || !files.length) {
          try { sessionStorage.removeItem(storageKey); } catch (err) {}
          return;
        }

        const entries = Array.from(files).slice(0, 10).map((file) => new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve({
            name: file.name,
            type: file.type,
            lastModified: file.lastModified,
            data: reader.result,
          });
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(file);
        }));

        Promise.all(entries).then((results) => {
          const cleaned = results.filter(Boolean);
          if (!cleaned.length) {
            try { sessionStorage.removeItem(storageKey); } catch (err) {}
            return;
          }
          try {
            sessionStorage.setItem(storageKey, JSON.stringify(cleaned));
          } catch (err) {
          }
        });
      }

      async function restoreFiles(input, storageKey, onAfterRestore) {
        if (!input || !storageKey) return;
        if (typeof DataTransfer === 'undefined') return;
        let stored = [];
        try {
          stored = JSON.parse(sessionStorage.getItem(storageKey) || '[]');
        } catch (err) {
          return;
        }
        if (!Array.isArray(stored) || !stored.length) return;

        const dataTransfer = new DataTransfer();
        for (const item of stored) {
          if (!item || !item.data) continue;
          try {
            const response = await fetch(item.data);
            const blob = await response.blob();
            const file = new File([blob], item.name || 'upload', {
              type: item.type || blob.type || 'application/octet-stream',
              lastModified: item.lastModified || Date.now(),
            });
            dataTransfer.items.add(file);
          } catch (err) {
            continue;
          }
        }

        if (dataTransfer.files.length) {
          input.files = dataTransfer.files;
          if (typeof onAfterRestore === 'function') onAfterRestore();
        }
      }

      function bootstrapExisting() {
        cleanIngredientsField();
        const rawShopping = (shoppingField.value || '').trim();
        if (!rawShopping) return;
        const lines = rawShopping.split(/\r?\n/);
        lines.forEach(line => {
          if (!line || !line.trim()) return;
          const parts = line.split('|');
          const name = (parts[0] || '').trim();
          const url = normalizeUrl((parts[1] || '').trim());
          if (name) {
            shoppingList.push({ name, url, previewUrl: null });
            shopImageFiles.push(null);
          }
        });
      }

      addBtn.addEventListener('click', addLink);
      itemInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addLink(); } });
      linkInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addLink(); } });
      formEl.addEventListener('submit', (event) => {
        const hasClientErrors = renderRequiredFieldErrors();
        if (hasClientErrors) {
          event.preventDefault();
          return;
        }
        cleanIngredientsField();
        syncShoppingField();
        syncShopImagesInput();
        persistFiles(imageInput, IMG_STORAGE_KEY);
      });

      if (!isBound) {
        try {
          sessionStorage.removeItem(IMG_STORAGE_KEY);
        } catch (err) {}
      } else if (hasErrors) {
        restoreFiles(imageInput, IMG_STORAGE_KEY, renderImagesList);
      }

      bootstrapExisting();
      renderList();
    })();
  </script>
{% endblock %}
