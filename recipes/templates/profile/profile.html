{% extends "base/base_profile.html" %}
{% load static %}

{% block profile_content %}
<main class="profile-shell container-fluid px-4 px-xl-5 pb-5">
  <section class="profile-hero text-center">
    <div class="profile-avatar">
      <img src="{{ profile.avatar_url }}" alt="{{ profile.display_name }} avatar">
    </div>
    <h1 class="profile-name">{{ profile.display_name }}</h1>
    <p class="profile-handle small mb-1">
      {{ profile.handle }} ·
      {% if can_view_follow_lists %}
        <button
          type="button"
          class="profile-follow-count"
          data-bs-toggle="modal"
          data-bs-target="#followersModal"
        >
          {{ profile.followers }} Followers
        </button>
      {% else %}
        <span class="profile-follow-count text-muted">{{ profile.followers }} Followers</span>
      {% endif %}
      ·
      {% if can_view_follow_lists %}
        <button
          type="button"
          class="profile-follow-count"
          data-bs-toggle="modal"
          data-bs-target="#followingModal"
        >
          {{ profile.following }} Following
        </button>
      {% else %}
        <span class="profile-follow-count text-muted">{{ profile.following }} Following</span>
      {% endif %}
      {% if is_own_profile %}
      ·
      <button
        type="button"
        class="profile-follow-count"
        data-bs-toggle="modal"
        data-bs-target="#closeFriendsModal"
      >
        {{ profile.close_friends_count|default:0 }} Close friends
      </button>
      {% endif %}
    </p>
    <p class="profile-tagline mb-3">{{ profile.tagline }}</p>
    <div class="profile-actions d-flex justify-content-center gap-2 flex-wrap">
      {% if is_own_profile %}
        <button type="button" class="profile-pill" data-bs-toggle="modal" data-bs-target="#editProfileModal">
          Edit Profile
        </button>
      {% else %}
        {% if pending_follow_request %}
          <form method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="cancel_request" value="1">
            <button type="submit" class="profile-pill">
              Requested
            </button>
          </form>
        {% else %}
          <form method="post" action="{% url 'toggle_follow' profile_user.username %}">
            {% csrf_token %}
            {% if is_following %}
              <button type="submit" class="profile-pill">
                Unfollow
              </button>
            {% else %}
              <button type="submit" class="profile-pill">
                Follow
              </button>
            {% endif %}
          </form>
        {% endif %}
      {% endif %}
    </div>    
  </section>

  <section class="mt-4">
    {% if can_view_profile %}
      {% if posts %}
        <div class="feed-masonry-grid" id="profile-posts-grid">
          <div class="feed-masonry-column" id="profile-posts-col-1">
            {% for post in posts %}
              {% if forloop.counter0|divisibleby:3 %}
                {% include "partials/feed/feed_card.html" %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="feed-masonry-column" id="profile-posts-col-2">
            {% for post in posts %}
              {% if forloop.counter0|add:"2"|divisibleby:3 %}
                {% include "partials/feed/feed_card.html" %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="feed-masonry-column" id="profile-posts-col-3">
            {% for post in posts %}
              {% if forloop.counter0|add:"1"|divisibleby:3 %}
                {% include "partials/feed/feed_card.html" %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div
          id="profile-posts-sentinel"
          class="infinite-sentinel"
          data-next-page="{{ posts_next_page }}"
          data-has-more="{{ posts_has_more|yesno:'true,false' }}"
          data-endpoint="{% url 'profile' %}{% if profile_user.username %}?user={{ profile_user.username|urlencode }}{% endif %}"
        ></div>
      {% else %}
        {% if is_own_profile %}
          <p class="text-muted mt-4">You haven't created any recipes yet.</p>
        {% else %}
          <p class="text-muted mt-4">This user hasn't created any recipes yet.</p>
        {% endif %}
      {% endif %}
    {% else %}
      <p class="text-muted mt-4">This account is private. Follow to see their recipes.</p>
    {% endif %}
  </section>
</main>

<div
  class="modal fade follow-modal"
  id="followersModal"
  tabindex="-1"
  aria-labelledby="followersModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title mb-0 follow-modal-title" id="followersModalLabel">Followers</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div
        class="modal-body follow-list-body px-4 pt-2"
        data-list-type="followers"
        data-endpoint="{% url 'profile_follow_list' %}?user={{ profile_user.username|urlencode }}&list=followers"
        data-next-page="{{ followers_next_page|default:'' }}"
        data-has-more="{{ followers_has_more|yesno:'true,false' }}"
      >
        {% if can_view_follow_lists %}
          <div class="mb-4">
            <input
              type="text"
              class="form-control"
              id="followersSearch"
              placeholder="Search followers"
            >
          </div>
          {% if followers_users %}
            <ul class="list-unstyled mb-0 follow-list-items" id="followersList">
              {% include "partials/profile/follow_list_items.html" with users=followers_users list_type="followers" is_own_profile=is_own_profile %}
            </ul>
            <div class="follow-list-sentinel" aria-hidden="true"></div>
          {% else %}
            <p class="text-muted mb-0 follow-empty-text">No followers yet.</p>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0 follow-empty-text">Followers are hidden for this account.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade follow-modal"
  id="followingModal"
  tabindex="-1"
  aria-labelledby="followingModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title mb-0 follow-modal-title" id="followingModalLabel">Following</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div
        class="modal-body follow-list-body px-4 pt-2"
        data-list-type="following"
        data-endpoint="{% url 'profile_follow_list' %}?user={{ profile_user.username|urlencode }}&list=following"
        data-next-page="{{ following_next_page|default:'' }}"
        data-has-more="{{ following_has_more|yesno:'true,false' }}"
      >
        {% if can_view_follow_lists %}
          <div class="mb-4">
            <input
              type="text"
              class="form-control"
              id="followingSearch"
              placeholder="Search following"
            >
          </div>
          {% if following_users %}
            <ul class="list-unstyled mb-0 follow-list-items" id="followingList">
              {% include "partials/profile/follow_list_items.html" with users=following_users list_type="following" is_own_profile=is_own_profile %}
            </ul>
            <div class="follow-list-sentinel" aria-hidden="true"></div>
          {% else %}
            <p class="text-muted mb-0 follow-empty-text">Not following anyone yet.</p>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0 follow-empty-text">Following list is hidden for this account.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if is_own_profile %}
<div
  class="modal fade follow-modal"
  id="closeFriendsModal"
  tabindex="-1"
  aria-labelledby="closeFriendsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title mb-0 follow-modal-title" id="closeFriendsModalLabel">Close friends</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div
        class="modal-body follow-list-body px-4 pt-2"
        data-list-type="close_friends"
        data-endpoint="{% url 'profile_follow_list' %}?user={{ profile_user.username|urlencode }}&list=close_friends"
        data-next-page="{{ close_friends_next_page|default:'' }}"
        data-has-more="{{ close_friends_has_more|yesno:'true,false' }}"
      >
        <div class="mb-4">
          <input
            type="text"
            class="form-control"
            id="closeFriendsSearch"
            placeholder="Search followers"
          >
        </div>
        {% if followers_users %}
          <ul class="list-unstyled mb-0 follow-list-items" id="closeFriendsList">
            {% include "partials/profile/close_friend_items.html" with users=followers_users close_friend_ids=close_friend_ids %}
          </ul>
          <div class="follow-list-sentinel" aria-hidden="true"></div>
        {% else %}
          <p class="text-muted mb-0 follow-empty-text">No followers to add.</p>
        {% endif %}
      </div>
    </div>
	  </div>
	</div>
	{% endif %}
{% endblock %}
