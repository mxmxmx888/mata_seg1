{# recipes/templates/create_recipe.html #}
{% extends "base.html" %}
{% load static %}
{% block body_class %}app-body{% endblock %}

{% block body %}
  {% include "partials/navbar_app.html" %}

  <main class="app-page">
    <div class="container-lg">

      <h1 class="hero-title create-recipe-title">Create a recipe</h1>
      <p class="hero-lead create-recipe-lead">
        Give it a title, a short description, then list ingredients and steps.
      </p>

      <div class="create-recipe-card">
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}

          {% include "partials/bootstrap_form.html" with form=form %}

          <div class="shopping-links-helper mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h5 class="mb-1 shopping-links-title">Shopping links</h5>
                <p class="text-muted small mb-0">Add an ingredient and optional URL; it will be inserted into the Ingredients box above on submit.</p>
              </div>
              <span class="badge rounded-pill bg-dark text-light">Optional</span>
            </div>

            <div class="row g-3 align-items-end shopping-links-row">
              <div class="col-12 col-md-5 col-lg-5">
                <label for="shop-item" class="form-label mb-1">Item</label>
                <input type="text" id="shop-item" class="form-control" placeholder="Matcha Powder">
              </div>
              <div class="col-12 col-md-5 col-lg-5">
                <label for="shop-link" class="form-label mb-1">Link</label>
                <input type="url" id="shop-link" class="form-control" placeholder="https://amazon.com/matcha">
              </div>
              <div class="col-12 col-md-2 col-lg-2 col-button">
                <button type="button" id="add-shop-link" class="btn btn-dark shop-add-btn">Add</button>
              </div>
            </div>

            <div class="mt-3 shopping-links-list">
              <div class="small fw-semibold text-muted mb-1">Added links</div>
              <div id="shop-list" class="shopping-list-box text-muted small">No shopping links added yet.</div>
            </div>

            <div class="text-muted small mt-2">
              Format saved: <code class="format-chip">Ingredient | https://link.com</code>. You can still edit the Ingredients field manually; links stay out of view here.
            </div>
          </div>

          <div class="small text-muted mb-2 mt-4">
            Tip: add tags like <code>#food</code>, <code>#dinner</code>, or <code>#private</code> in the tags field to control how your recipes are discovered.
          </div>

          <div class="mt-3 text-center">
            <button type="submit" class="btn-save-recipe">
              Save recipe
            </button>
          </div>
        </form>
      </div>

    </div>
  </main>

  <style>
    .shopping-links-helper {
      background: #f8f9fb;
      border: 1px solid #e6e8ee;
      border-radius: 12px;
      padding: 1.25rem;
      overflow: hidden;
    }
    .shopping-links-title {
      color: #0f0f14;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .shopping-links-helper .badge {
      letter-spacing: 0.03em;
    }
    .format-chip {
      color: #d63384;
      font-weight: 600;
    }
    .shopping-links-row .col-button {
      display: flex;
      align-items: stretch;
    }
    .shop-add-btn {
      width: 100%;
      font-size: 0.9rem;
      line-height: 1.2;
      padding: 0.65rem 0.75rem;
      min-height: 52px;
      font-weight: 700;
      border-radius: 10px;
      border: 1px solid #0f0f14;
      word-break: break-word;
      white-space: normal;
    }
    .shopping-list-box {
      background: #ffffff;
      border: 1px dashed #d6d9e2;
      border-radius: 10px;
      padding: 0.75rem;
      min-height: 48px;
    }
    .shopping-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      color: #0f0f14;
      font-weight: 600;
    }
    .shopping-list-item .note {
      color: #7a7f8c;
      font-weight: 500;
      font-size: 0.85rem;
      margin-left: 0.35rem;
    }
    .shopping-list-item .remove {
      font-size: 0.8rem;
    }
    @media (max-width: 768px) {
      .shop-add-btn { min-height: 46px; }
    }
  </style>

  <script>
    (function() {
      // --- FIX: Select the form inside the card, ignoring the navbar search form ---
      const formEl = document.querySelector('.create-recipe-card form');
      // -----------------------------------------------------------------------------
      
      const ingredientsField = document.getElementById('id_ingredients_text');
      const itemInput = document.getElementById('shop-item');
      const linkInput = document.getElementById('shop-link');
      const addBtn = document.getElementById('add-shop-link');
      const listBox = document.getElementById('shop-list');
      const shoppingList = [];

      if (!formEl || !ingredientsField || !itemInput || !linkInput || !addBtn || !listBox) return;

      function normalizeUrl(url) {
        if (!url) return '';
        return /^https?:\/\//i.test(url) ? url : 'https://' + url;
      }

      function renderList() {
        if (!shoppingList.length) {
          listBox.innerHTML = '<div class="text-muted small">No shopping links added yet.</div>';
          return;
        }
        listBox.innerHTML = shoppingList.map((item, idx) => `
          <div class="shopping-list-item" data-idx="${idx}">
            <div>
              <span>${item.name}</span>
              <span class="note">${item.url ? '(link saved)' : '(no link)'}</span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary remove" data-idx="${idx}">Remove</button>
          </div>
        `).join('');

        listBox.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', () => {
            const i = parseInt(btn.dataset.idx, 10);
            shoppingList.splice(i, 1);
            renderList();
          });
        });
      }

      function addLink() {
        const name = (itemInput.value || '').trim();
        const rawUrl = (linkInput.value || '').trim();
        if (!name) {
          itemInput.focus();
          return;
        }

        shoppingList.push({ name, url: normalizeUrl(rawUrl) });
        renderList();

        itemInput.value = '';
        linkInput.value = '';
        itemInput.focus();
      }

      function prepareIngredientsForSubmit() {
        const manual = (ingredientsField.value || '').trim();
        const manualLines = manual ? manual.split(/\r?\n/).map(l => l.trim()).filter(Boolean) : [];
        const shoppingLines = shoppingList.map(item => item.url ? `${item.name} | ${item.url}` : item.name);
        const finalLines = [...manualLines, ...shoppingLines];
        ingredientsField.value = finalLines.join('\n');
      }

      function bootstrapExisting() {
        const raw = (ingredientsField.value || '').trim();
        if (!raw) return;
        const lines = raw.split(/\r?\n/);
        const manualKeep = [];
        lines.forEach(line => {
          if (line.includes('|')) {
            const parts = line.split('|');
            const name = (parts[0] || '').trim();
            const url = normalizeUrl((parts[1] || '').trim());
            if (name) shoppingList.push({ name, url });
          } else {
            if (line.trim()) manualKeep.push(line.trim());
          }
        });
        ingredientsField.value = manualKeep.join('\n');
        renderList();
      }

      addBtn.addEventListener('click', addLink);
      itemInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addLink(); } });
      linkInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addLink(); } });
      formEl.addEventListener('submit', prepareIngredientsForSubmit);

      bootstrapExisting();
      renderList();
    })();
  </script>
{% endblock %}