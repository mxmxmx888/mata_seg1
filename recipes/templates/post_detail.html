{% extends "base.html" %}

{% block body_class %}dashboard-body{% endblock %}

{% block body %}
<main class="container-fluid px-4 px-xl-5 py-4 post-page position-relative">
  <div class="post-primary" id="post-primary">
  <div class="row g-5 align-items-start">
        <div class="col-xxl-5 col-xl-5 col-lg-5">
      <div class="post-media-wrap position-relative">
        <a class="post-back-button" href="{% url 'dashboard' %}" aria-label="Go back">
          <i class="bi bi-chevron-left"></i>
        </a>
        <div class="recipe-gallery">
          {% if image_url %}
          <div class="gallery-item gallery-item--main">
            <img
              src="{{ image_url }}"
              alt="{{ title }}"
              class="gallery-img js-gallery-image"
              data-fullsrc="{{ image_url }}"
            >
          </div>
          {% endif %}

          {% for gallery_image in gallery_images %}
          <div class="gallery-item">
            <img
              src="{{ gallery_image }}"
              alt="Gallery image {{ forloop.counter }}"
              class="gallery-img js-gallery-image"
              data-fullsrc="{{ gallery_image }}"
            >
          </div>
          {% endfor %}
        </div>

        {% if video_url %}
        <div class="post-video-standalone mt-3">
          <div class="post-video">
            <video controls playsinline poster="{{ image_url }}">
              <source src="{{ video_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        </div>
        {% endif %}
      </div>
    </div>


    <div class="col-xxl-4 col-xl-4 col-lg-4">
      <header class="mb-4">
        <p class="post-author text-muted mb-1">by {{ author_handle }}</p>
        <h1 class="post-title">{{ title }}</h1>
        <div class="d-flex flex-wrap gap-3 post-meta">
          <span>⏱ {{ cook_time }}</span>
          <span>� Serves {{ serves }}</span>
          <span>� {{ ingredients|length }} ingredients</span>
          <span class="badge bg-secondary text-uppercase" style="letter-spacing:0.05em;">
            {% if recipe.visibility == 'public' %}Public{% elif recipe.visibility == 'followers' %}Followers only{% else %}Close friends only{% endif %}
          </span>
        </div>
      </header>

      <p class="post-summary text-muted mb-4">{{ summary }}</p>

      {% if shop_ingredients %}
      <section class="mb-4">
        <h2 class="h6 fw-bold text-uppercase mb-3 text-muted small tracking-wide">
          <i class="bi bi-bag-fill me-2"></i>Shop this recipe
        </h2>
        <div class="d-flex flex-wrap gap-2">
          {% for ing in shop_ingredients %}
            <a href="{{ ing.shop_url }}" target="_blank" class="btn btn-dark rounded-pill d-inline-flex align-items-center gap-2 py-2 px-3" style="background-color: #000; border-color: #000; font-size: 0.85rem;">
              <span>{{ ing.name|title }}</span>
              <i class="bi bi-arrow-up-right small text-white-50"></i>
            </a>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <section class="mb-4">
        <h2 class="h4 fw-semibold mb-2">Ingredients</h2>
        <ul class="post-ingredients mt-1">
          {% for ingredient in ingredients %}
          <li class="d-flex align-items-center justify-content-between">
            <span>{{ ingredient.name|title }}</span>
            
            {% if ingredient.shop_url %}
            <a href="{{ ingredient.shop_url }}" target="_blank" class="text-decoration-none text-muted opacity-75 hover-opacity-100" title="Buy {{ ingredient.name }}">
              <i class="bi bi-bag-fill"></i>
            </a>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </section>

      <section class="mb-4">
        <h2 class="h4 fw-semibold mb-2">Steps</h2>
        <ol class="post-steps mt-1">
          {% for step in steps %}
          <li>{{ step }}</li>
          {% endfor %}
        </ol>
      </section>

      {% if tags %}
      <section class="post-tags mb-4">
        <button class="post-tags-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#post-tags-collapse" aria-expanded="false" aria-controls="post-tags-collapse">
          <span class="fw-semibold">Tags</span>
          <i class="bi bi-chevron-down post-tags-chevron" aria-hidden="true"></i>
        </button>
        <div id="post-tags-collapse" class="collapse">
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% for tag in tags %}
            <span class="post-tag-pill">#{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <section class="d-flex gap-2">
        <button class="btn btn-dark rounded-pill px-3">Cook this</button>
      </section>
    </div>

    <div class="col-xxl-3 col-xl-3 col-lg-3">
      <aside class="post-comments-panel">
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <p class="text-muted small mb-1">
              {{ post_date }}
              <span class="mx-1">&middot;</span>
              <a href="{% url 'report_content' 'recipe' recipe.id %}" class="text-danger text-decoration-none" title="Report this recipe">
                <i class="bi bi-flag"></i> Report
              </a>
            </p>
            <p class="fw-semibold mb-0">{{ title }}</p>
            <a class="post-source-link" href="{{ source_link }}">Shared via {{ source_label }}</a>
          </div>
          <button class="post-save-button" type="button" aria-label="Save recipe">+</button>
        </div>
        
        <h2 class="h6 text-uppercase text-muted mb-3 post-engagement-inline">
          <span>{{ likes_count|default:0 }} likes</span>
          <span>{{ comments.count }} comments</span>
          <span>{{ saves_count|default:0 }} saves</span>
        </h2>

        <div class="mb-4">
          <form action="{% url 'add_comment' recipe.id %}" method="post" class="d-flex gap-2">
            {% csrf_token %}
            <div class="flex-grow-1">
              {{ comment_form.text }}
            </div>
            <button type="submit" class="btn btn-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
              <i class="bi bi-send-fill" style="font-size: 0.9rem;"></i>
            </button>
          </form>
        </div>

        <div class="post-comments-list">
          {% for comment in comments %}
          <div class="post-comment d-flex align-items-start justify-content-between mb-3">
            <div class="d-flex align-items-start gap-2">
              <div class="comment-avatar" style="min-width: 32px; width: 32px; height: 32px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; color: #555;">
                <img
                  src="{{ comment.user.mini_avatar_url }}"
                  alt="{{ comment.user.username }} avatar"
                  style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                >
              </div>
              <div>
                <div class="d-flex align-items-baseline gap-2">
                  <p class="mb-0 fw-bold" style="font-size: 0.9rem;">{{ comment.user.username }}</p>
                  <span class="text-muted small" style="font-size: 0.75rem;">{{ comment.created_at|timesince }} ago</span>
                </div>
                <p class="mb-0 text-dark small" style="line-height: 1.4;">{{ comment.text }}</p>
              </div>
            </div>
            
            <div class="d-flex align-items-center gap-2">
              {% if request.user == comment.user %}
              <form action="{% url 'delete_comment' comment.id %}" method="post" onsubmit="return confirm('Delete this comment?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-link text-danger p-0 border-0 opacity-50 hover-opacity-100" style="font-size: 0.8rem;" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
              {% endif %}
              
              <a href="{% url 'report_content' 'comment' comment.id %}" class="text-secondary opacity-50 hover-opacity-100" title="Report">
                <i class="bi bi-flag" style="font-size: 0.8rem;"></i>
              </a>
            </div>
          </div>
          {% empty %}
          <div class="text-center py-4">
            <p class="text-muted small mb-0">No comments yet. Be the first!</p>
          </div>
          {% endfor %}
        </div>
      </aside>
    </div>
  </div>

  </div>

  <div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content save-modal">
        <div class="modal-header border-0 align-items-center">
          <div class="d-flex flex-column">
            <h5 class="modal-title" id="saveModalLabel">
              <span data-save-title="list">Save to collection</span>
              <span data-save-title="create" class="d-none">New collection</span>
            </h5>
            <p class="small text-muted mb-0" data-save-subtitle="list">Choose a collection for this recipe.</p>
            <p class="small text-muted mb-0 d-none" data-save-subtitle="create">Name your new collection to save this recipe.</p>
          </div>
          <div class="save-modal-header-actions d-flex align-items-center gap-2">
            <button type="button" class="save-modal-icon-btn" data-save-open-create data-hide-when-view="create" aria-label="Create new collection">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
        <div class="modal-body">
          <div class="save-modal-view" data-save-view="list">
            <div class="save-modal-search mb-3">
              <i class="bi bi-search"></i>
              <input type="text" class="form-control" placeholder="Search collections" />
            </div>
            <ul class="save-modal-list list-unstyled mb-0">
              <li class="save-modal-row">
                <div class="save-modal-avatar" aria-hidden="true">W</div>
            <div>
              <p class="mb-0 fw-semibold">Weeknight dinners</p>
              <p class="mb-0 text-muted small">Quick · Private</p>
            </div>
            <button type="button" class="save-modal-action" aria-label="Select Weeknight dinners" data-save-toggle>
              <i class="bi bi-bookmark-fill"></i>
            </button>
          </li>
            </ul>
          </div>
          <div class="save-modal-view d-none" data-save-view="create">
            <form id="save-modal-create-form">
              <div class="mb-3">
                <label for="new-collection-name" class="form-label text-muted small">Collection name</label>
                <input type="text" class="save-modal-input" id="new-collection-name" name="name" placeholder="e.g. Cozy winter dishes" required>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-3" data-save-back>Cancel</button>
                <button type="submit" class="btn btn-dark rounded-pill px-3">Create</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if view_similar %}
  <section class="post-view-similar mt-5">
    <div class="d-flex align-items-center justify-content-center gap-2 mb-4">
      <i class="bi bi-binoculars"></i>
      <span class="fw-semibold text-uppercase small tracking-wide">View similar</span>
    </div>
    <div class="view-similar-grid view-similar-grid-wide">
      {% for item in view_similar %}
      <a href="{{ item.url }}" class="view-similar-card">
        <div class="view-similar-media">
          <img src="{{ item.image }}" alt="{{ item.title }}">
        </div>
        <p class="view-similar-title mb-1">{{ item.title }}</p>
        <p class="view-similar-meta text-muted small mb-0">{{ item.description }}</p>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}
</main>

<div id="lightbox" class="lightbox d-none">
  <div class="lightbox-backdrop"></div>

  <div class="lightbox-inner">
    <button class="lightbox-close" type="button">&times;</button>

    <button class="lightbox-arrow lightbox-arrow--left" type="button">&#10094;</button>

    <img id="lightbox-image" class="lightbox-image" alt="Recipe image">

    <button class="lightbox-arrow lightbox-arrow--right" type="button">&#10095;</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const thumbs = Array.from(document.querySelectorAll('.js-gallery-image'));
  if (!thumbs.length) return;

  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-image');
  const btnClose = lightbox.querySelector('.lightbox-close');
  const btnPrev = lightbox.querySelector('.lightbox-arrow--left');
  const btnNext = lightbox.querySelector('.lightbox-arrow--right');
  const backdrop = lightbox.querySelector('.lightbox-backdrop');

  let currentIndex = 0;

  function showImage(index) {
    const count = thumbs.length;
    currentIndex = (index + count) % count;
    const img = thumbs[currentIndex];
    const src = img.dataset.fullsrc || img.src;
    lightboxImg.src = src;
  }

  function openLightbox(index) {
    showImage(index);
    lightbox.classList.remove('d-none');
  }

  function closeLightbox() {
    lightbox.classList.add('d-none');
  }

  thumbs.forEach((img, idx) => {
    img.addEventListener('click', () => openLightbox(idx));
  });

  btnClose.addEventListener('click', closeLightbox);
  backdrop.addEventListener('click', closeLightbox);

  btnPrev.addEventListener('click', () => showImage(currentIndex - 1));
  btnNext.addEventListener('click', () => showImage(currentIndex + 1));

  document.addEventListener('keydown', (e) => {
    if (lightbox.classList.contains('d-none')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
    if (e.key === 'ArrowRight') showImage(currentIndex + 1);
  });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const primary = document.getElementById('post-primary');
  const similar = document.querySelector('.post-view-similar');

  const tagsToggle = document.querySelector('.post-tags-toggle');
  const tagsCollapse = document.getElementById('post-tags-collapse');
  const hasBootstrapCollapse = !!(window.bootstrap && bootstrap.Collapse);
  const hasBootstrapModal = !!(window.bootstrap && bootstrap.Modal);
  const syncTagsChevron = () => {
    if (!tagsToggle || !tagsCollapse) return;
    const isOpen = tagsCollapse.classList.contains('show');
    tagsToggle.classList.toggle('open', isOpen);
    tagsToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  };

  if (tagsToggle && tagsCollapse) {
    if (hasBootstrapCollapse) {
      tagsCollapse.addEventListener('shown.bs.collapse', syncTagsChevron);
      tagsCollapse.addEventListener('hidden.bs.collapse', syncTagsChevron);
    }
    tagsToggle.addEventListener('click', function () {
      if (!hasBootstrapCollapse) {
        tagsCollapse.classList.toggle('show');
      }
      window.setTimeout(syncTagsChevron, 0);
    });
  }

  syncTagsChevron();

  // Save modal open/close (works with or without Bootstrap JS)
  const saveButton = document.querySelector('.post-save-button');
  const saveModal = document.getElementById('saveModal');
  const saveModalListView = saveModal ? saveModal.querySelector('[data-save-view="list"]') : null;
  const saveModalCreateView = saveModal ? saveModal.querySelector('[data-save-view="create"]') : null;
  const saveModalTitles = saveModal ? saveModal.querySelectorAll('[data-save-title]') : [];
  const saveModalSubtitles = saveModal ? saveModal.querySelectorAll('[data-save-subtitle]') : [];
  const saveOpenCreate = saveModal ? saveModal.querySelector('[data-save-open-create]') : null;
  const saveHideOnCreate = saveModal ? saveModal.querySelectorAll('[data-hide-when-view="create"]') : [];
  const saveToggleButtons = saveModal ? saveModal.querySelectorAll('[data-save-toggle]') : [];
  const saveBackBtn = saveModal ? saveModal.querySelector('[data-save-back]') : null;
  const saveCreateForm = document.getElementById('save-modal-create-form');
  const saveNameInput = document.getElementById('new-collection-name');
  let saveModalInstance = null;
  let fallbackOutsideHandler = null;

  const ensureBackdrop = (show) => {
    const existing = document.querySelector('.modal-backdrop');
    if (show) {
      if (existing) return existing;
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      document.body.appendChild(backdrop);
      return backdrop;
    }
    if (existing) existing.remove();
    return null;
  };

  const setSaveView = (view) => {
    if (!saveModal) return;
    saveModal.dataset.saveView = view;
    if (saveModalListView) saveModalListView.classList.toggle('d-none', view !== 'list');
    if (saveModalCreateView) saveModalCreateView.classList.toggle('d-none', view !== 'create');
    saveModalTitles.forEach((el) => el.classList.toggle('d-none', el.getAttribute('data-save-title') !== view));
    saveModalSubtitles.forEach((el) => el.classList.toggle('d-none', el.getAttribute('data-save-subtitle') !== view));
    saveHideOnCreate.forEach((el) => el.classList.toggle('d-none', view === 'create'));
  };

  const showSaveModal = (view = 'list') => {
    if (!saveModal) return;
    setSaveView(view);
    if (saveNameInput) saveNameInput.value = '';
    document.body.classList.add('modal-open');
    if (hasBootstrapModal) {
      saveModalInstance = bootstrap.Modal.getOrCreateInstance(saveModal);
      saveModalInstance.show();
    } else {
      saveModal.classList.add('show');
      saveModal.style.display = 'block';
      saveModal.removeAttribute('aria-hidden');
      ensureBackdrop(true);
      window.setTimeout(() => {
        fallbackOutsideHandler = (e) => {
          const dialog = saveModal.querySelector('.modal-dialog');
          const launchedFromButton = saveButton && (saveButton === e.target || saveButton.contains(e.target));
          if (launchedFromButton) return;
          if (dialog && dialog.contains(e.target)) return;
          hideSaveModal();
        };
        document.addEventListener('click', fallbackOutsideHandler);
      }, 0);
    }
  };

  const hideSaveModal = () => {
    if (!saveModal) return;
    if (hasBootstrapModal && saveModalInstance) {
      saveModalInstance.hide();
    } else {
      saveModal.classList.remove('show');
      saveModal.style.display = 'none';
      saveModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
      ensureBackdrop(false);
      if (fallbackOutsideHandler) {
        document.removeEventListener('click', fallbackOutsideHandler);
        fallbackOutsideHandler = null;
      }
    }
  };

  if (saveButton && saveModal) {
    saveButton.addEventListener('click', function (e) {
      e.preventDefault();
      showSaveModal();
    });
    saveModal.querySelectorAll('[data-dismiss-save-modal]').forEach((btn) => {
      btn.addEventListener('click', hideSaveModal);
    });

    if (saveOpenCreate) {
      saveOpenCreate.addEventListener('click', function (e) {
        e.preventDefault();
        setSaveView('create');
        if (saveNameInput) saveNameInput.focus();
      });
    }

    if (saveBackBtn) {
      saveBackBtn.addEventListener('click', function (e) {
        e.preventDefault();
        setSaveView('list');
      });
    }

    if (saveCreateForm) {
      saveCreateForm.addEventListener('submit', function (e) {
        e.preventDefault();
        hideSaveModal();
      });
    }

    saveToggleButtons.forEach((btn) => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const icon = btn.querySelector('i');
        if (!icon) return;
        if (icon.classList.contains('bi-bookmark-fill')) {
          icon.classList.remove('bi-bookmark-fill');
          icon.classList.add('bi-bookmark');
        } else {
          icon.classList.remove('bi-bookmark');
          icon.classList.add('bi-bookmark-fill');
        }
      });
    });

    if (hasBootstrapModal) {
      saveModal.addEventListener('shown.bs.modal', () => setSaveView('list'));
    }
  }

  // Masonry logic
  const masonry = document.querySelector('.post-media-masonry');
  const masonryItems = masonry ? Array.from(masonry.querySelectorAll('.post-media-masonry-item')) : [];
  const ensureMasonryCols = () => {
    if (!masonry) return [];
    let cols = Array.from(masonry.querySelectorAll('.post-media-masonry-col'));
    if (cols.length === 0) {
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < 2; i += 1) {
        const col = document.createElement('div');
        col.className = 'post-media-masonry-col';
        fragment.appendChild(col);
      }
      masonry.prepend(fragment);
      cols = Array.from(masonry.querySelectorAll('.post-media-masonry-col'));
    }
    return cols;
  };

  const buildMasonry = () => {
    if (!masonry || masonryItems.length === 0) return;
    const cols = ensureMasonryCols();
    if (cols.length === 0) return;
    const colCount = 2;
    const activeCols = cols.slice(0, colCount);
    cols.forEach((col, index) => {
      col.innerHTML = '';
      col.style.display = index < colCount ? 'flex' : 'none';
    });
    const heights = activeCols.map(() => 0);
    masonryItems.forEach((item) => {
      const media = item.querySelector('img, video');
      const height = media && media.getBoundingClientRect().height ? media.getBoundingClientRect().height : item.getBoundingClientRect().height || 1;
      const target = colCount === 1 ? 0 : (heights[0] <= heights[1] ? 0 : 1);
      activeCols[target].appendChild(item);
      heights[target] += height;
    });
  };

  const requestMasonry = () => window.requestAnimationFrame(buildMasonry);
  masonryItems.forEach((item) => {
    const media = item.querySelector('img, video');
    if (media) {
      if (media.complete) {
        requestMasonry();
      } else {
        media.addEventListener('load', requestMasonry, { once: true });
      }
    }
  });

  window.addEventListener('resize', requestMasonry);
  requestMasonry();

  // Dynamic similar items grid
  const similarGrids = Array.from(document.querySelectorAll('.view-similar-grid, .view-similar-grid-wide'));
  const baselineWidths = new Map();
  const setBaselines = () => {
    similarGrids.forEach((grid) => {
      const baseCols = grid.classList.contains('view-similar-grid-wide') ? 4 : 3;
      const width = grid.clientWidth || grid.offsetWidth;
      if (!width) return;
      baselineWidths.set(grid, width / baseCols);
    });
  };
  const updateSimilarColumns = () => {
    similarGrids.forEach((grid) => {
      const baseWidth = baselineWidths.get(grid);
      const width = grid.clientWidth || grid.offsetWidth;
      if (!baseWidth || !width) return;
      const cols = Math.max(1, Math.round(width / baseWidth));
      grid.style.setProperty('--similar-cols', cols);
    });
  };

  // Fading primary content on scroll
  const handleScroll = () => {
    if (!primary || !similar) return;
    const rect = similar.getBoundingClientRect();
    const windowHeight = window.innerHeight || document.documentElement.clientHeight;
    const fadeStart = windowHeight * 1.0;
    const fadeEnd = windowHeight * 0.4;
    const progress = Math.min(1, Math.max(0, (fadeStart - rect.top) / (fadeStart - fadeEnd)));
    primary.style.setProperty('--post-fade-amount', progress.toFixed(2));
  };

  window.addEventListener('scroll', handleScroll);
  window.addEventListener('resize', updateSimilarColumns);
  window.addEventListener('resize', handleScroll);

  setBaselines();
  updateSimilarColumns();
});
</script>
{% endblock %}
