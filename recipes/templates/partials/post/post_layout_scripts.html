<script>
document.addEventListener('DOMContentLoaded', function () {
  const primary = document.getElementById('post-primary');
  const similar = document.querySelector('.post-view-similar');

  const masonry = document.querySelector('.post-media-masonry');
  const masonryItems = masonry ? Array.from(masonry.querySelectorAll('.post-media-masonry-item')) : [];

  const ensureMasonryCols = () => {
    if (!masonry) return [];
    let cols = Array.from(masonry.querySelectorAll('.post-media-masonry-col'));
    if (cols.length === 0) {
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < 2; i += 1) {
        const col = document.createElement('div');
        col.className = 'post-media-masonry-col';
        fragment.appendChild(col);
      }
      masonry.prepend(fragment);
      cols = Array.from(masonry.querySelectorAll('.post-media-masonry-col'));
    }
    return cols;
  };

  const buildMasonry = () => {
    if (!masonry || masonryItems.length === 0) return;
    const cols = ensureMasonryCols();
    if (cols.length === 0) return;
    const colCount = window.innerWidth <= 768 ? 1 : 2;
    masonry.style.gridTemplateColumns = `repeat(${colCount}, minmax(0, 1fr))`;
    const activeCols = cols.slice(0, colCount);
    cols.forEach((col, index) => {
      col.innerHTML = '';
      col.style.display = index < colCount ? 'flex' : 'none';
    });
    const heights = activeCols.map(() => 0);
    masonryItems.forEach((item) => {
      const media = item.querySelector('img, video');
      const height = media && media.getBoundingClientRect().height ? media.getBoundingClientRect().height : item.getBoundingClientRect().height || 1;
      const target = colCount === 1 ? 0 : (heights[0] <= heights[1] ? 0 : 1);
      activeCols[target].appendChild(item);
      heights[target] += height;
    });
  };

  const requestMasonry = () => window.requestAnimationFrame(buildMasonry);
  masonryItems.forEach((item) => {
    const media = item.querySelector('img, video');
    if (media) {
      if (media.complete) {
        requestMasonry();
      } else {
        media.addEventListener('load', requestMasonry, { once: true });
      }
    }
  });

  window.addEventListener('resize', requestMasonry);
  requestMasonry();

  const similarGrids = Array.from(document.querySelectorAll('.view-similar-grid, .view-similar-grid-wide'));
  const baselineWidths = new Map();
  const setBaselines = () => {
    similarGrids.forEach((grid) => {
      const baseCols = grid.classList.contains('view-similar-grid-wide') ? 4 : 3;
      const width = grid.clientWidth || grid.offsetWidth;
      if (!width) return;
      baselineWidths.set(grid, width / baseCols);
    });
  };
  const updateSimilarColumns = () => {
    similarGrids.forEach((grid) => {
      const baseWidth = baselineWidths.get(grid);
      const width = grid.clientWidth || grid.offsetWidth;
      if (!baseWidth || !width) return;
      const cols = Math.max(1, Math.round(width / baseWidth));
      grid.style.setProperty('--similar-cols', cols);
    });
  };

  const handleScroll = () => {
    if (!primary || !similar) return;
    const rect = similar.getBoundingClientRect();
    const windowHeight = window.innerHeight || document.documentElement.clientHeight;
    const fadeStart = windowHeight * 1.0;
    const fadeEnd = windowHeight * 0.4;
    const progress = Math.min(1, Math.max(0, (fadeStart - rect.top) / (fadeStart - fadeEnd)));
    primary.style.setProperty('--post-fade-amount', progress.toFixed(2));
  };

  window.addEventListener('scroll', handleScroll);
  window.addEventListener('resize', updateSimilarColumns);
  window.addEventListener('resize', handleScroll);

  setBaselines();
  updateSimilarColumns();

  const backButton = document.querySelector('.post-back-button');
  const lightbox = document.getElementById('lightbox');
  const triggerBack = () => {
    if (backButton) {
      backButton.click();
      return;
    }
    window.history.back();
  };

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape' || event.defaultPrevented) return;
    const modalOpen = document.querySelector('.modal.show');
    const lightboxOpen = lightbox && !lightbox.classList.contains('d-none');
    if (modalOpen || lightboxOpen) return;
    triggerBack();
  });

  const likeForm = document.querySelector('[data-like-form]');
  if (likeForm) {
    const likeButton = likeForm.querySelector('[data-like-toggle]');
    const likeIcon = likeButton ? likeButton.querySelector('i') : null;
    const likeCountEl = likeForm.querySelector('[data-like-count]');
    const csrfInput = likeForm.querySelector('input[name=csrfmiddlewaretoken]')
      || document.querySelector('input[name=csrfmiddlewaretoken]');
    const csrfToken = csrfInput ? csrfInput.value : '';

    const setLikeState = (liked, count) => {
      if (!likeButton || !likeIcon) return;
      likeButton.dataset.liked = liked ? 'true' : 'false';
      likeButton.setAttribute('aria-pressed', liked ? 'true' : 'false');
      likeIcon.classList.toggle('bi-heart-fill', liked);
      likeIcon.classList.toggle('bi-heart', !liked);
      likeButton.classList.toggle('is-liked', liked);
      if (likeCountEl && typeof count === 'number' && !Number.isNaN(count)) {
        likeCountEl.textContent = Math.max(0, count);
      }
    };

    const parseCount = () => {
      if (!likeCountEl) return 0;
      const parsed = parseInt(likeCountEl.textContent, 10);
      return Number.isNaN(parsed) ? 0 : parsed;
    };

    likeForm.addEventListener('submit', (event) => {
      if (!likeButton || !likeIcon || !csrfToken || typeof fetch === 'undefined') return;
      event.preventDefault();
      const wasLiked = likeButton.dataset.liked === 'true';
      const nextCount = wasLiked ? parseCount() - 1 : parseCount() + 1;
      likeButton.disabled = true;

      fetch(likeForm.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: '',
      })
        .then((resp) => {
          if (resp && resp.ok) {
            setLikeState(!wasLiked, nextCount);
            return;
          }
          likeForm.submit();
        })
        .catch(() => likeForm.submit())
        .finally(() => {
          likeButton.disabled = false;
        });
    });
  }
});
</script>
