<aside class="col-xxl-4 col-xl-4 col-lg-4">
  <div class="post-comments-panel">
    <header class="post-comments-topbar mb-3">
      <div class="dropdown post-actions-dropdown">
        <button
          class="comment-icon-btn"
          type="button"
          id="post-actions-dropdown-{{ recipe.id }}"
          data-bs-toggle="dropdown"
          data-bs-display="static"
          aria-expanded="false"
          aria-label="More options"
        >
          <i class="bi bi-three-dots"></i>
        </button>
        <ul
          class="dropdown-menu dropdown-menu-end post-actions-dropdown-menu"
          aria-labelledby="post-actions-dropdown-{{ recipe.id }}"
        >
          {% if request.user.is_authenticated %}
            {% if request.user == recipe.author %}
              <li>
                <a class="dropdown-item" href="{% url 'recipe_edit' recipe.id %}">
                  Edit recipe
                </a>
              </li>
              <li>
                <form
                  action="{% url 'delete_my_recipe' recipe.id %}"
                  method="post"
                  onsubmit="return confirm('Delete this post? This cannot be undone.');"
                >
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item text-danger">Delete post</button>
                </form>
              </li>
            {% else %}
              <li>
                <a class="dropdown-item text-danger" href="{% url 'report_content' 'recipe' recipe.id %}">
                  Report post
                </a>
              </li>
            {% endif %}
          {% else %}
            <li>
              <a class="dropdown-item" href="{% url 'log_in' %}">Log in to report</a>
            </li>
          {% endif %}
        </ul>
      </div>
      <div class="post-comments-topbar-actions">
        <form
          method="post"
          action="{% url 'toggle_like' recipe.id %}"
          class="comment-like-form"
          data-like-form
        >
          {% csrf_token %}
          <span class="comment-like-count" data-like-count aria-live="polite">
            {{ likes_count|default:0 }}
          </span>
          <button
            type="submit"
            class="comment-icon-btn comment-like-btn {% if user_liked %}is-liked{% endif %}"
            data-like-toggle
            data-liked="{{ user_liked|yesno:'true,false' }}"
            aria-label="{% if user_liked %}Unlike{% else %}Like{% endif %}"
            aria-pressed="{{ user_liked|yesno:'true,false' }}"
          >
            <i class="bi {% if user_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
          </button>
        </form>
        <button
          class="comment-icon-btn comment-icon-btn--primary"
          type="button"
          aria-label="Save to collection"
          data-open-save-modal
        >
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>
    </header>

    <p class="text-muted small mb-3">Comments Â· {{ comments|length }}</p>

    {% if request.user.is_authenticated %}
    <form action="{% url 'add_comment' recipe.id %}" method="post" class="mb-3">
      {% csrf_token %}
      <div class="mb-2">
        <textarea
          class="form-control"
          name="text"
          rows="2"
          placeholder="Share your thoughts..."
          required
        ></textarea>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-sm btn-dark rounded-pill px-3">
          Comment
        </button>
      </div>
    </form>
    {% else %}
    <p class="text-muted small mb-3">
      <a href="{% url 'log_in' %}">Log in</a> to add a comment.
    </p>
    {% endif %}

    <div class="post-comments-list">
      {% for comment in comments %}
      <div class="post-comment">
        <div class="comment-avatar">
          <a href="{% url 'profile' %}?user={{ comment.user.username|urlencode }}">
            <img
              src="{{ comment.user.mini_avatar_url }}"
              alt="{{ comment.user.username }} avatar"
            >
          </a>
        </div>
        <div class="comment-body">
          <div class="comment-header">
            <span class="comment-author">{{ comment.user.username }}</span>
            <span class="comment-timestamp">{{ comment.created_at|timesince }} ago</span>
          </div>
          <p class="comment-text">{{ comment.text }}</p>
        </div>
        <div class="comment-actions">
          {% if request.user == comment.user %}
          <form action="{% url 'delete_comment' comment.id %}" method="post" onsubmit="return confirm('Delete this comment?');">
            {% csrf_token %}
            <button type="submit" class="comment-action-btn" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </form>
          {% endif %}
          
          <a href="{% url 'report_content' 'comment' comment.id %}" class="comment-action-btn" title="Report">
            <i class="bi bi-flag"></i>
          </a>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-4">
        <p class="text-muted small mb-0">No comments yet. Be the first!</p>
      </div>
      {% endfor %}
    </div>
  </div>
</aside>
