{% load widget_tweaks %}
<aside class="col-xxl-4 col-xl-4 col-lg-4">
  <div class="post-comments-panel">
    <header class="post-comments-topbar mb-3">
      <div class="dropdown post-actions-dropdown">
        <button
          class="comment-icon-btn"
          type="button"
          id="post-actions-dropdown-{{ recipe.id }}"
          data-bs-toggle="dropdown"
          data-bs-display="static"
          aria-expanded="false"
          aria-label="More options"
        >
          <i class="bi bi-three-dots"></i>
        </button>
        <ul
          class="dropdown-menu dropdown-menu-end post-actions-dropdown-menu"
          aria-labelledby="post-actions-dropdown-{{ recipe.id }}"
        >
          {% if request.user.is_authenticated %}
            {% if request.user == recipe.author %}
              <li>
                <a class="dropdown-item" href="{% url 'recipe_edit' recipe.id %}">
                  Edit recipe
                </a>
              </li>
              <li>
                <form
                  action="{% url 'delete_my_recipe' recipe.id %}"
                  method="post"
                  onsubmit="return confirm('Delete this post? This cannot be undone.');"
                >
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item text-danger">Delete post</button>
                </form>
              </li>
            {% else %}
              <li>
                <a class="dropdown-item text-danger" href="{% url 'report_content' 'recipe' recipe.id %}">
                  Report post
                </a>
              </li>
            {% endif %}
          {% else %}
            <li>
              <a class="dropdown-item" href="{% url 'log_in' %}">Log in to report</a>
            </li>
          {% endif %}
        </ul>
      </div>
      <div class="post-comments-topbar-actions">
        <form
          method="post"
          action="{% url 'toggle_like' recipe.id %}"
          class="comment-like-form"
          data-like-form
        >
          {% csrf_token %}
          <span class="comment-like-count" data-like-count aria-live="polite">
            {{ likes_count|default:0 }}
          </span>
          <button
            type="submit"
            class="comment-icon-btn comment-like-btn {% if user_liked %}is-liked{% endif %}"
            data-like-toggle
            data-liked="{{ user_liked|yesno:'true,false' }}"
            aria-label="{% if user_liked %}Unlike{% else %}Like{% endif %}"
            aria-pressed="{{ user_liked|yesno:'true,false' }}"
          >
            <i class="bi {% if user_liked %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
          </button>
        </form>
        <button
          class="comment-icon-btn comment-icon-btn--primary"
          type="button"
          aria-label="Save to collection"
          data-open-save-modal
        >
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>
    </header>

    <p class="text-muted small mb-3">Comments Â· {{ comments|length }}</p>

    {% if request.user.is_authenticated %}
      <form action="{% url 'add_comment' recipe.id %}" method="post" class="mb-3">
        {% csrf_token %}
        <div class="mb-2">
          {% if comment_form.text.errors %}
            {% render_field comment_form.text class="form-control is-invalid" %}
          {% else %}
            {% render_field comment_form.text class="form-control" %}
          {% endif %}
          {% if comment_form.text.errors %}
            <div class="invalid-feedback d-block">
              {{ comment_form.text.errors|join:", " }}
            </div>
          {% endif %}
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-sm btn-dark rounded-pill px-3">
            Comment
          </button>
        </div>
      </form>
    {% else %}
    <p class="text-muted small mb-3">
      <a href="{% url 'log_in' %}">Log in</a> to add a comment.
    </p>
    {% endif %}

    <div class="post-comments-list" id="post-comments-list">
      {% include "partials/post/comment_items.html" with comments=comments %}
      {% if not comments %}
      <div class="text-center py-4">
        <p class="text-muted small mb-0">No comments yet. Be the first!</p>
      </div>
      {% endif %}
      <div
        id="comments-sentinel"
        data-next-page="{{ comments_next_page }}"
        data-comments-endpoint="{% url 'recipe_detail' recipe.id %}"
        data-has-more="{{ comments_has_more|yesno:'true,false' }}"
        style="height:1px;width:100%;margin:0;padding:0;"
      ></div>
    </div>
  </div>
</aside>

<script>
  (function() {
    const sentinel = document.getElementById("comments-sentinel");
    if (!sentinel) return;
    const list = document.getElementById("post-comments-list");
    const endpoint = sentinel.getAttribute("data-comments-endpoint");

    function fetchMore() {
      const hasMore = sentinel.getAttribute("data-has-more") === "true";
      const next = sentinel.getAttribute("data-next-page");
      if (!hasMore || !next) return;
      const url = `${endpoint}?comments_page=${next}&comments_only=1`;
      sentinel.setAttribute("data-has-more", "false");
      fetch(url, { headers: { "HX-Request": "true" } })
        .then((resp) => resp.text())
        .then((html) => {
          if (html.trim() === "") {
            return;
          }
          // Insert new comments just before the sentinel so it stays at the end.
          sentinel.insertAdjacentHTML("beforebegin", html);
          const countReturned = (html.match(/post-comment/g) || []).length;
          if (countReturned < 50) {
            sentinel.setAttribute("data-has-more", "false");
            observer.disconnect();
          } else {
            sentinel.setAttribute("data-has-more", "true");
            sentinel.setAttribute("data-next-page", parseInt(next, 10) + 1);
          }
        })
        .catch(() => observer.disconnect());
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            fetchMore();
          }
        });
      },
      { root: null, threshold: 0.1 }
    );

    observer.observe(sentinel);
  })();
</script>
