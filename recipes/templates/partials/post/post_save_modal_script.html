<script>
document.addEventListener('DOMContentLoaded', function () {
  const saveModal = document.getElementById('saveModal');
  if (!saveModal) return;

  const saveModalViews = Array.from(saveModal.querySelectorAll('.save-modal-view'));
  const saveModalList = saveModal.querySelector('.save-modal-list');
  const saveSearchInput = saveModal.querySelector('.save-modal-search input');
  const saveOpenCreate = saveModal.querySelector('[data-save-open-create]');
  const saveBackBtn = saveModal.querySelector('[data-save-back]');
  const saveCreateForm = document.getElementById('save-modal-create-form');
  const saveNameInput = document.getElementById('new-collection-name');
  const hasBootstrapModal = typeof bootstrap !== 'undefined' && bootstrap.Modal;
  let fallbackBackdrop = null;
  let saveNoResultsRow = null;
  const saveToggleButtons = Array.from(saveModal.querySelectorAll('[data-save-toggle]'));
  const csrfInput = document.querySelector('input[name=csrfmiddlewaretoken]');
  const csrfToken = csrfInput ? csrfInput.value : '';
  const saveEndpoint = "{% url 'toggle_favourite' recipe.id %}";

  function getSaveRows() {
    if (!saveModalList) return [];
    return Array.from(saveModalList.querySelectorAll('.save-modal-row'));
  }

  function ensureSaveNoResultsRow() {
    if (saveNoResultsRow || !saveModalList) return saveNoResultsRow;
    saveNoResultsRow = saveModalList.querySelector('.save-modal-no-results');
    if (saveNoResultsRow) return saveNoResultsRow;
    saveNoResultsRow = document.createElement('li');
    saveNoResultsRow.className = 'text-muted small px-1 py-2 save-modal-no-results d-none';
    saveNoResultsRow.textContent = 'No collections found';
    saveModalList.appendChild(saveNoResultsRow);
    return saveNoResultsRow;
  }

  function setRowSearchValue(row, name) {
    if (!row) return;
    row.setAttribute('data-collection-name', (name || '').toLowerCase());
  }

  function filterSaveModalList() {
    if (!saveModalList || !saveSearchInput) return;
    const rows = getSaveRows();
    if (!rows.length) return;
    const term = saveSearchInput.value.trim().toLowerCase();
    let visibleCount = 0;
    rows.forEach((row) => {
      const name = row.getAttribute('data-collection-name') || '';
      const match = !term || name.indexOf(term) !== -1;
      row.classList.toggle('d-none', !match);
      if (match) visibleCount += 1;
    });
    const noResults = ensureSaveNoResultsRow();
    if (noResults) {
      noResults.classList.toggle('d-none', visibleCount !== 0);
    }
  }

  function resetSaveModalSearch() {
    if (!saveSearchInput) return;
    saveSearchInput.value = '';
    filterSaveModalList();
  }

  if (saveModalList) {
    getSaveRows().forEach((row) => {
      const nameEl = row.querySelector('.fw-semibold');
      const rowName = nameEl ? nameEl.textContent : '';
      setRowSearchValue(row, rowName);
    });
  }

  if (saveSearchInput) {
    saveSearchInput.addEventListener('input', filterSaveModalList);
  }

  function setSaveView(view) {
    if (!saveModalViews.length) return;
    saveModalViews.forEach((v) => {
      const isTarget = v.getAttribute('data-save-view') === view;
      v.classList.toggle('d-none', !isTarget);
    });

    const titles = saveModal.querySelectorAll('[data-save-title]');
    const subtitles = saveModal.querySelectorAll('[data-save-subtitle]');
    titles.forEach((t) => {
      t.classList.toggle('d-none', t.getAttribute('data-save-title') !== view);
    });
    subtitles.forEach((s) => {
      s.classList.toggle('d-none', s.getAttribute('data-save-subtitle') !== view);
    });

    const hideOnCreateElems = saveModal.querySelectorAll('[data-hide-when-view]');
    hideOnCreateElems.forEach((el) => {
      const hideOn = el.getAttribute('data-hide-when-view') || '';
      el.classList.toggle('d-none', hideOn === view);
    });
  }

  function ensureFallbackBackdrop() {
    if (fallbackBackdrop) return fallbackBackdrop;
    const el = document.createElement('div');
    el.className = 'modal-backdrop fade custom-modal-backdrop';
    document.body.appendChild(el);
    fallbackBackdrop = el;
    return el;
  }

  function showSaveModal() {
    setSaveView('list');
    resetSaveModalSearch();
    if (hasBootstrapModal) {
      const instance = bootstrap.Modal.getOrCreateInstance(saveModal);
      instance.show();
      return;
    }
    const backdrop = ensureFallbackBackdrop();
    backdrop.style.display = 'block';
    window.requestAnimationFrame(() => backdrop.classList.add('show'));
    backdrop.onclick = hideSaveModal;

    saveModal.classList.add('show');
    saveModal.style.display = 'block';
    saveModal.removeAttribute('aria-hidden');

    document.body.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
  }

  function hideSaveModal() {
    if (hasBootstrapModal) {
      const instance = bootstrap.Modal.getOrCreateInstance(saveModal);
      instance.hide();
      return;
    }
    saveModal.classList.remove('show');
    saveModal.style.display = 'none';
    saveModal.setAttribute('aria-hidden', 'true');

    if (fallbackBackdrop) {
      fallbackBackdrop.classList.remove('show');
      fallbackBackdrop.style.display = 'none';
      fallbackBackdrop.onclick = null;
    }

    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
  }

  const saveButtons = Array.from(document.querySelectorAll('[data-open-save-modal]'));
  saveButtons.forEach((btn) => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      showSaveModal();
    });
  });

  saveModal.querySelectorAll('[data-dismiss-save-modal]').forEach((btn) => {
    btn.addEventListener('click', hideSaveModal);
  });

  if (saveOpenCreate) {
    saveOpenCreate.addEventListener('click', function (e) {
      e.preventDefault();
      setSaveView('create');
      if (saveNameInput) saveNameInput.focus();
    });
  }

  if (saveBackBtn) {
    saveBackBtn.addEventListener('click', function (e) {
      e.preventDefault();
      setSaveView('list');
    });
  }

  const attachToggleHandler = (btn) => {
    if (!btn || btn.dataset.saveHandlerAttached === '1') return;
    btn.dataset.saveHandlerAttached = '1';

    const row = btn.closest('.save-modal-row');

    const handleToggle = (e) => {
      e.preventDefault();
      const collectionId = btn.getAttribute('data-collection-id');
      const icon = btn.querySelector('i');
      if (!collectionId || !icon) return;

      const body = new URLSearchParams({
        collection_id: collectionId,
      }).toString();

      fetch(saveEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        body,
      })
        .then((resp) => (resp.ok ? resp.json().catch(() => null) : null))
        .then((data) => {
          const saved = data && Object.prototype.hasOwnProperty.call(data, 'saved')
            ? !!data.saved
            : !icon.classList.contains('bi-bookmark-fill');
          icon.classList.toggle('bi-bookmark-fill', saved);
          icon.classList.toggle('bi-bookmark', !saved);
        })
        .catch(() => {
          const saved = !icon.classList.contains('bi-bookmark-fill');
          icon.classList.toggle('bi-bookmark-fill', saved);
          icon.classList.toggle('bi-bookmark', !saved);
        });
    };

    btn.addEventListener('click', handleToggle);

    if (row) {
      row.addEventListener('click', (e) => {
        if (e.target.closest('[data-save-toggle]')) return;
        handleToggle(e);
      });
    }
  };

  if (saveCreateForm) {
    saveCreateForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const name = (saveNameInput && saveNameInput.value ? saveNameInput.value : '').trim();
      if (!name) {
        if (saveNameInput) saveNameInput.focus();
        return;
      }

      const body = new URLSearchParams({
        collection_name: name,
      }).toString();

      fetch(saveEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        body,
      })
        .then((resp) => resp.ok ? resp.json().catch(() => null) : null)
        .then((data) => {
          if (!data || !data.collection || !saveModalList) return;
          const col = data.collection;
          let row = saveModalList.querySelector(`[data-collection-id="${col.id}"]`);
          const saved = !!data.saved;
          if (!row) {
            row = document.createElement('li');
            row.className = 'save-modal-row';
            row.setAttribute('data-collection-id', col.id);
            row.innerHTML = `
              <div class="save-modal-avatar${col.thumb_url ? ' save-modal-avatar-has-thumb' : ''}" aria-hidden="true">
                ${col.thumb_url ? `<img src="${col.thumb_url}" alt="" class="save-modal-avatar-img">` : (col.name || '').charAt(0).toUpperCase()}
              </div>
              <div>
                <p class="mb-0 fw-semibold"></p>
                <p class="mb-0 text-muted small">Private</p>
              </div>
              <button
                type="button"
                class="save-modal-action"
                data-save-toggle
                data-collection-id="${col.id}"
                aria-label="Toggle ${col.name || ''}"
              >
                <i class="bi"></i>
              </button>
            `;
            saveModalList.appendChild(row);
          }

          const nameEl = row.querySelector('p.mb-0.fw-semibold') || row.querySelector('p.fw-semibold');
          if (nameEl) {
            nameEl.textContent = col.name || '';
            setRowSearchValue(row, col.name || '');
          }
          const toggleBtn = row.querySelector('[data-save-toggle]');
          const icon = toggleBtn ? toggleBtn.querySelector('i') : null;
          if (icon) {
            icon.classList.toggle('bi-bookmark-fill', saved);
            icon.classList.toggle('bi-bookmark', !saved);
          }
          attachToggleHandler(toggleBtn);
          filterSaveModalList();
          setSaveView('list');
          hideSaveModal();
        })
        .catch(() => {
          hideSaveModal();
        });
    });
  }

  saveToggleButtons.forEach(attachToggleHandler);

  saveModal.addEventListener('click', (e) => {
    if (!saveModal.classList.contains('show')) return;
    const dialog = saveModal.querySelector('.modal-dialog');
    if (dialog && dialog.contains(e.target)) return;
    hideSaveModal();
  });

  if (hasBootstrapModal) {
    saveModal.addEventListener('shown.bs.modal', () => setSaveView('list'));
  }

  filterSaveModalList();
});
</script>
