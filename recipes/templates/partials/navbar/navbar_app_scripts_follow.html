<script>
  document.addEventListener('DOMContentLoaded', function () {
    const getCsrfToken = (form) => form.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    const buildFetchHeaders = (form) => {
      const csrfToken = getCsrfToken(form);
      return Object.assign(
        { 'X-Requested-With': 'XMLHttpRequest' },
        csrfToken ? { 'X-CSRFToken': csrfToken } : {}
      );
    };

    const followForms = document.querySelectorAll('.notification-follow-form');
    if (followForms.length) {
      followForms.forEach(function (form) {
        form.addEventListener('submit', function (event) {
          event.preventDefault();

          const button = form.querySelector('button[data-follow-state]');
          if (!button) {
            form.submit();
            return;
          }

          const currentState = button.getAttribute('data-follow-state') || 'not-following';
          const formData = new FormData(form);

          fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: buildFetchHeaders(form),
            redirect: 'manual'
          }).then(function () {
            if (currentState === 'not-following') {
              button.textContent = 'Following';
              button.classList.remove('btn-primary');
              button.classList.add('btn-outline-light');
              button.setAttribute('data-follow-state', 'following');
            } else {
              button.textContent = 'Follow';
              button.classList.remove('btn-outline-light');
              button.classList.add('btn-primary');
              button.setAttribute('data-follow-state', 'not-following');
            }
          }).catch(function () {
            form.submit();
          });
        });
      });
    }

    const notifItems = document.querySelectorAll('.notification-item[data-post-url]');
    if (notifItems.length) {
      notifItems.forEach(function (item) {
        item.addEventListener('click', function (event) {
          const url = item.dataset.postUrl;
          if (!url) return;

          if (event.target.closest('a, button, form')) {
            return;
          }

          window.location.href = url;
        });
      });
    }

    const requestForms = document.querySelectorAll('.notification-follow-request-form');
    if (requestForms.length) {
      requestForms.forEach(function (form) {
        form.addEventListener('submit', function (event) {
          event.preventDefault();

          const action = form.dataset.action;
          const item = form.closest('[data-notification-id]');
          const message = item?.querySelector('.notification-message');
          const actionsRow = item?.querySelector('.notification-follow-request-actions');

          fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: buildFetchHeaders(form),
            redirect: 'manual'
          }).then(function () {
            if (!item) return;

            if (action === 'accept') {
              if (message) {
                message.textContent = 'started following you.';
              }
              if (actionsRow) {
                actionsRow.remove();
              }
            } else if (action === 'reject') {
              item.remove();
            }
          }).catch(function () {
            form.submit();
          });
        });
      });
    }
  });
</script>
