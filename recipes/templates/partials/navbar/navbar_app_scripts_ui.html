<script>
  document.addEventListener('DOMContentLoaded', function () {
    const floatingMenuProps = ['position', 'top', 'left', 'right', 'transform', 'width', 'max-width'];

    const resetFloatingMenuStyles = (menuEl) => {
      if (!menuEl) return;
      floatingMenuProps.forEach((prop) => {
        menuEl.style.removeProperty(prop);
      });
    };

    const getDropdownOffset = () => {
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--navbar-dropdown-offset');
      const parsed = parseFloat(raw);
      return Number.isFinite(parsed) ? parsed : 18;
    };

    const positionFloatingMenu = ({
      trigger,
      menu,
      breakpoint = 640,
      margin = 12,
      maxWidth = 360,
      offset = getDropdownOffset()
    }) => {
      if (!trigger || !menu) return;
      if (window.innerWidth > breakpoint) {
        resetFloatingMenuStyles(menu);
        return;
      }

      const computedMaxWidth = Math.min(maxWidth, window.innerWidth - margin * 2);
      const left = Math.max(margin, (window.innerWidth - computedMaxWidth) / 2);
      const triggerRect = trigger.getBoundingClientRect();
      const top = Math.max(margin, triggerRect.bottom + offset);

      menu.style.setProperty('position', 'fixed', 'important');
      menu.style.setProperty('top', `${top}px`, 'important');
      menu.style.setProperty('left', `${left}px`, 'important');
      menu.style.setProperty('right', 'auto', 'important');
      menu.style.setProperty('transform', 'none', 'important');
      menu.style.setProperty('width', `${computedMaxWidth}px`, 'important');
      menu.style.setProperty('max-width', `${window.innerWidth - margin * 2}px`, 'important');
    };

    const toggleBtn = document.getElementById("prepTimeToggle");
    const popover = document.getElementById("prepFilterPopover");

    if (toggleBtn && popover) {
      const positionPopover = () => positionFloatingMenu({
        trigger: toggleBtn,
        menu: popover,
        breakpoint: 640,
        maxWidth: 360,
        offset: getDropdownOffset()
      });

      toggleBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        const shouldOpen = !popover.classList.contains("prep-filter-open");
        popover.classList.toggle("prep-filter-open", shouldOpen);
        if (shouldOpen) {
          positionPopover();
        }
      });

      document.addEventListener("click", function (e) {
        if (!popover.contains(e.target) && !toggleBtn.contains(e.target)) {
          popover.classList.remove("prep-filter-open");
        }
      });

      window.addEventListener('resize', function () {
        if (popover.classList.contains("prep-filter-open")) {
          positionPopover();
        }
      });
    }

    const notifDropdowns = Array.from(document.querySelectorAll('#notificationDropdown, #notificationDropdownMobile'));
    if (notifDropdowns.length) {
      let markedRead = false;
      const trackedMenus = [];
      const dropdownOffset = getDropdownOffset();

      const updateAllNotificationMenus = () => {
        trackedMenus.forEach(({ trigger, menu }) => positionFloatingMenu({
          trigger,
          menu,
          breakpoint: 590,
          maxWidth: 420,
          offset: dropdownOffset
        }));
      };

      window.addEventListener('resize', updateAllNotificationMenus);

      const markRead = () => {
        if (markedRead) return;
        markedRead = true;
        fetch("{% url 'mark_notifications_read' %}", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" }
        }).catch(() => {});
      };

      const attachHandlers = (dropdownEl) => {
        const icon = dropdownEl.querySelector('i');
        const dropdownMenu = dropdownEl.closest('.dropdown')?.querySelector('.dropdown-menu');

        if (dropdownMenu) {
          trackedMenus.push({ trigger: dropdownEl, menu: dropdownMenu });
        }

        const fillHeart = () => {
          if (!icon) return;
          icon.classList.remove('bi-heart');
          icon.classList.add('bi-heart-fill');
        };

        const unfillHeart = () => {
          if (!icon) return;
          icon.classList.remove('bi-heart-fill');
          icon.classList.add('bi-heart');
        };

        const clearDot = () => {
          const dot = dropdownEl.querySelector('.notification-dot');
          if (dot && dot.parentNode) {
            dot.remove();
          }
        };

        const handleOpen = () => {
          clearDot();
          fillHeart();
          markRead();
          positionFloatingMenu({
            trigger: dropdownEl,
            menu: dropdownMenu,
            breakpoint: 590,
            maxWidth: 420,
            offset: dropdownOffset
          });
        };

        const handleClose = () => {
          unfillHeart();
          positionFloatingMenu({
            trigger: dropdownEl,
            menu: dropdownMenu,
            breakpoint: 590,
            maxWidth: 420,
            offset: dropdownOffset
          });
        };

        const syncFromState = () => {
          const isOpen =
            dropdownEl.getAttribute('aria-expanded') === 'true' ||
            (dropdownMenu && dropdownMenu.classList.contains('show'));

          if (isOpen) {
            handleOpen();
          } else {
            handleClose();
          }
        };

        dropdownEl.addEventListener('show.bs.dropdown', handleOpen);
        dropdownEl.addEventListener('shown.bs.dropdown', handleOpen);
        dropdownEl.addEventListener('hidden.bs.dropdown', handleClose);

        dropdownEl.addEventListener('click', function () {
          setTimeout(syncFromState, 0);
        });

        if (dropdownMenu && window.MutationObserver) {
          const observer = new MutationObserver(syncFromState);
          observer.observe(dropdownMenu, { attributes: true, attributeFilter: ['class'] });
        }
      };

      notifDropdowns.forEach(attachHandlers);
    }

    const searchInput = document.querySelector('.recipi-nav-search-input');
    if (searchInput) {
      const recipeSuggestions = [
        "15 minute pasta",
        "one-pan chicken",
        "banana protein milkshake",
        "sheet-pan salmon",
        "chocolate protein oats"
      ];

      const prefix = "Try ‘";
      const suffix = "’";
      const compactPlaceholder = "Search...";
      const fullSearchPlaceholder = "Search Recipi...";

      let placeholderIndex = 0;
      let charIndex = 0;
      let isDeleting = false;
      let typingTimeoutId = null;
      let animationActive = true;

      const isCompact = () => searchInput.clientWidth > 0 && searchInput.clientWidth < 260;
      const getSearchPlaceholder = () => isCompact() ? compactPlaceholder : fullSearchPlaceholder;

      function updatePlaceholder(textFragment) {
        if (isCompact()) {
          searchInput.placeholder = compactPlaceholder;
          return;
        }
        const middle = textFragment || "";
        const closing = middle ? suffix : "";
        searchInput.placeholder = prefix + middle + closing;
      }

      function typePlaceholder() {
        if (!animationActive) return;

        if (isCompact()) {
          searchInput.placeholder = compactPlaceholder;
          typingTimeoutId = setTimeout(typePlaceholder, 800);
          return;
        }

        if (document.activeElement === searchInput || (searchInput.value && searchInput.value.trim() !== '')) {
          typingTimeoutId = setTimeout(typePlaceholder, 500);
          return;
        }

        const currentRecipe = recipeSuggestions[placeholderIndex];

        if (!isDeleting) {
          charIndex += 1;
          const visible = currentRecipe.slice(0, charIndex);
          updatePlaceholder(visible);

          if (charIndex === currentRecipe.length) {
            isDeleting = true;
            typingTimeoutId = setTimeout(typePlaceholder, 1500);
            return;
          }
        } else {
          charIndex -= 1;
          const visible = currentRecipe.slice(0, Math.max(charIndex, 0));
          updatePlaceholder(visible);

          if (charIndex <= 0) {
            isDeleting = false;
            placeholderIndex = (placeholderIndex + 1) % recipeSuggestions.length;
          }
        }

        const delay = isDeleting ? 40 : 80;
        typingTimeoutId = setTimeout(typePlaceholder, delay);
      }

      searchInput.addEventListener('focus', function () {
        animationActive = false;
        if (typingTimeoutId) {
          clearTimeout(typingTimeoutId);
          typingTimeoutId = null;
        }
        searchInput.placeholder = getSearchPlaceholder();
      });

      searchInput.addEventListener('blur', function () {
        if (searchInput.value && searchInput.value.trim() !== '') return;
        if (!animationActive) {
          animationActive = true;
          typePlaceholder();
        }
      });

      window.addEventListener('resize', function () {
        if (document.activeElement === searchInput) {
          searchInput.placeholder = getSearchPlaceholder();
          return;
        }

        if (typingTimeoutId) {
          clearTimeout(typingTimeoutId);
          typingTimeoutId = null;
        }
        animationActive = true;
        charIndex = 0;
        isDeleting = false;
        updatePlaceholder("");
        typePlaceholder();
      });

      updatePlaceholder("");
      typePlaceholder();
    }

    const appMenuToggle = document.querySelector('.app-menu-toggle');
    const appFullScreenMenu = document.getElementById('appFullScreenMenu');
    if (appMenuToggle && appFullScreenMenu) {
      const appMenuCloseBtn = document.querySelector('.app-fullscreen-menu-close');

      const setMenuState = (shouldOpen) => {
        if (shouldOpen) {
          appFullScreenMenu.classList.add('is-open');
          appFullScreenMenu.setAttribute('aria-hidden', 'false');
          appMenuToggle.classList.add('is-open');
          appMenuToggle.setAttribute('aria-expanded', 'true');
          document.body.classList.add('app-menu-open');
        } else {
          appFullScreenMenu.classList.remove('is-open');
          appFullScreenMenu.setAttribute('aria-hidden', 'true');
          appMenuToggle.classList.remove('is-open');
          appMenuToggle.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('app-menu-open');
        }
      };

      const toggleMenu = (shouldOpen) => {
        const isCurrentlyOpen = appFullScreenMenu.classList.contains('is-open');
        const nextState = typeof shouldOpen === 'boolean' ? shouldOpen : !isCurrentlyOpen;
        setMenuState(nextState);
      };

      appMenuToggle.addEventListener('click', () => toggleMenu());

      appFullScreenMenu.addEventListener('click', (event) => {
        if (event.target === appFullScreenMenu) {
          toggleMenu(false);
        }
      });

      appFullScreenMenu.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => toggleMenu(false));
      });

      if (appMenuCloseBtn) {
        appMenuCloseBtn.addEventListener('click', () => toggleMenu(false));
      }
    }
  });
</script>
