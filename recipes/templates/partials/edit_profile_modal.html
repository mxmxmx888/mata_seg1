{% load static %}
{% load widget_tweaks %}

{% if request.user.is_authenticated and edit_profile_form %}
<div
  class="modal fade edit-profile-modal"
  id="editProfileModal"
  tabindex="-1"
  aria-labelledby="editProfileModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
          <div class="edit-profile-layout">
        <aside class="edit-profile-sidebar">
          <div class="edit-profile-sidebar-top">
            <div class="edit-profile-avatar-wrapper">
              <div class="edit-profile-avatar-circle edit-profile-avatar-compact" data-avatar-preview style="width: 96px; height: 96px;">
                <img
                  src="{% if edit_profile_avatar_url %}{{ edit_profile_avatar_url }}{% endif %}"
                  alt="{{ user.username }} avatar"
                  data-avatar-image
                  class="{% if not edit_profile_avatar_url %}d-none{% endif %}"
                  style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                >
                <span
                  class="edit-profile-avatar-initial{% if edit_profile_avatar_url %} d-none{% endif %}"
                  data-avatar-initial
                >
                  {{ request.user.username|first|upper }}
                </span>
                <button
                  type="button"
                  class="edit-profile-avatar-edit"
                  aria-label="Change profile photo"
                  data-avatar-edit
                >
                  <i class="bi bi-pencil-fill"></i>
                </button>
              </div>
            </div>
            <nav class="edit-profile-nav" aria-label="Profile sections">
              <button type="button" class="edit-profile-nav-item active" data-section="profile">
                Profile
              </button>
              <button type="button" class="edit-profile-nav-item" data-section="account">
                Account
              </button>
              <button type="button" class="edit-profile-nav-item" data-section="password">
                Password
              </button>
            </nav>
          </div>
        </aside>

        <div class="edit-profile-main">
          <div class="modal-header border-0 px-0">
            <div>
              <h5 class="modal-title mb-0" id="editProfileModalLabel">
                Profile
              </h5>
            </div>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body px-0">
            <form
              method="post"
              action="{% url 'profile' %}"
              id="editProfileForm"
              enctype="multipart/form-data"
            >
              {% csrf_token %}
              <div class="d-none">
                <div class="edit-profile-avatar-input">
                  {% render_field edit_profile_form.avatar class="form-control" accept="image/*" data-avatar-input="1" %}
                </div>
                {{ edit_profile_form.remove_avatar|add_class:"d-none"|attr:"data-remove-avatar-input=1" }}
              </div>

              <div class="edit-profile-section" data-section="profile">
                {% for field in edit_profile_form %}
                  {% if field.name != "email" and field.name != "avatar" and field.name != "remove_avatar" and field.name != "is_private" %}
                    <div class="mb-3">
                      {{ field.label_tag }}
                      {% if edit_profile_form.is_bound %}
                        {% if field.errors %}
                          {% render_field field class="form-control is-invalid" %}
                        {% else %}
                          {% render_field field class="form-control is-valid" %}
                        {% endif %}
                      {% else %}
                        {% render_field field class="form-control" %}
                      {% endif %}
                      <div class="invalid-feedback">
                        {{ field.errors }}
                      </div>
                    </div>
                  {% elif field.name == "is_private" %}
                    <div class="mb-3">
                      <div class="d-flex align-items-center justify-content-between gap-3 p-3 rounded-3" style="background:#161616; border:1px solid #2a2a2a;" data-privacy-toggle>
                        <div>
                          <div class="text-muted small text-uppercase">Privacy</div>
                          <div class="fw-semibold" data-privacy-status>
                            {% if field.value %}Private{% else %}Public{% endif %}
                          </div>
                        </div>
                        <button type="button" class="btn btn-light rounded-pill px-3" data-privacy-button>
                          {% if field.value %}Make public{% else %}Make private{% endif %}
                        </button>
                      </div>
                      {% render_field field class="form-check-input d-none" %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="edit-profile-section d-none" data-section="account">
                {% for field in edit_profile_form %}
                  {% if field.name == "email" %}
                    <div class="mb-3">
                      {{ field.label_tag }}
                      {% if edit_profile_form.is_bound %}
                        {% if field.errors %}
                          {% render_field field class="form-control is-invalid" %}
                        {% else %}
                          {% render_field field class="form-control is-valid" %}
                        {% endif %}
                      {% else %}
                        {% render_field field class="form-control" %}
                      {% endif %}
                      <div class="invalid-feedback">
                        {{ field.errors }}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </form>

            <form
              method="post"
              action="{% url 'password' %}"
              id="passwordForm"
              class="d-none edit-profile-password-form"
            >
              {% csrf_token %}
              {% include 'partials/bootstrap_form.html' with form=password_form %}
            </form>

            <div class="edit-profile-section d-none" data-section="password"></div>
          </div>

          <div class="modal-footer border-0 px-0">
            <button
              type="submit"
              form="editProfileForm"
              class="btn btn-light rounded-pill px-3 edit-profile-submit-profile d-none"
            >
              Save
            </button>
            <button
              type="submit"
              form="passwordForm"
              class="btn btn-light rounded-pill px-3 edit-profile-submit-password d-none"
            >
              Change password
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  (function () {
    var modal = document.getElementById("editProfileModal");
    if (!modal) return;

    var navItems = modal.querySelectorAll(".edit-profile-nav-item");
    var sections = modal.querySelectorAll(".edit-profile-section");
    var profileForm = modal.querySelector("#editProfileForm");
    var passwordForm = modal.querySelector("#passwordForm");
    var profileSubmit = modal.querySelector(".edit-profile-submit-profile");
    var passwordSubmit = modal.querySelector(".edit-profile-submit-password");
    var modalTitle = modal.querySelector("#editProfileModalLabel");
    var avatarInputs = modal.querySelectorAll("[data-avatar-input]");
    var avatarEditButtons = modal.querySelectorAll("[data-avatar-edit]");
    var primaryAvatarInput = avatarInputs.length ? avatarInputs[0] : null;
    var removeAvatarInput = modal.querySelector("[data-remove-avatar-input]");
    var removeAvatarBtn = modal.querySelector("[data-remove-avatar]");
    var avatarImages = modal.querySelectorAll("[data-avatar-image]");
    var avatarInitials = modal.querySelectorAll("[data-avatar-initial]");
    var privacyToggle = modal.querySelector("[data-privacy-toggle]");
    var privacyButton = modal.querySelector("[data-privacy-button]");
    var privacyStatus = modal.querySelector("[data-privacy-status]");
    var privacyInput = modal.querySelector("input[name='is_private']");
    var initialAvatarUrl = "";
    if (removeAvatarInput && !removeAvatarInput.defaultValue) {
      removeAvatarInput.defaultValue = removeAvatarInput.value || "false";
    }
    avatarImages.forEach(function (img) {
      if (!initialAvatarUrl && img.getAttribute("src")) {
        initialAvatarUrl = img.getAttribute("src");
      }
    });
    var currentSection = "profile";
    var profileDirty = false;
    var passwordDirty = false;

    function showAvatarInitial() {
      avatarImages.forEach(function (img) {
        img.classList.add("d-none");
        img.removeAttribute("src");
      });
      avatarInitials.forEach(function (span) {
        span.classList.remove("d-none");
      });
    }

    function showAvatarImage(url) {
      if (!url) return;
      avatarImages.forEach(function (img) {
        img.src = url;
        img.classList.remove("d-none");
      });
      avatarInitials.forEach(function (span) {
        span.classList.add("d-none");
      });
    }

    function recomputeDirty() {
      profileDirty = false;
      passwordDirty = false;

      if (profileForm) {
        profileForm.querySelectorAll("input, textarea, select").forEach(function (el) {
          var isCheckbox = el.type === "checkbox" || el.type === "radio";
          var changed = isCheckbox
            ? el.checked !== el.defaultChecked
            : el.value !== el.defaultValue;
          if (changed) profileDirty = true;
        });
      }

      if (passwordForm) {
        passwordForm.querySelectorAll("input, textarea, select").forEach(function (el) {
          var isCheckbox = el.type === "checkbox" || el.type === "radio";
          var changed = isCheckbox
            ? el.checked !== el.defaultChecked
            : el.value !== el.defaultValue;
          if (changed) passwordDirty = true;
        });
      }
    }

    function syncPrivacyUI() {
      if (!privacyInput || !privacyButton || !privacyStatus) return;
      var isPrivate = privacyInput.checked;
      privacyStatus.textContent = isPrivate ? "Private" : "Public";
      privacyButton.textContent = isPrivate ? "Make public" : "Make private";
    }

    if (privacyButton && privacyInput) {
      privacyButton.addEventListener("click", function () {
        privacyInput.checked = !privacyInput.checked;
        syncPrivacyUI();
        recomputeDirty();
        updateButtons();
      });
      syncPrivacyUI();
    }

    function updateButtons() {
      if (currentSection === "password") {
        if (profileSubmit) profileSubmit.classList.add("d-none");
        if (passwordSubmit) {
          passwordSubmit.classList.toggle("d-none", !passwordDirty);
        }
      } else {
        if (passwordSubmit) passwordSubmit.classList.add("d-none");
        if (profileSubmit) {
          profileSubmit.classList.toggle("d-none", !profileDirty);
        }
      }
    }

    function activateSection(sectionName) {
      currentSection = sectionName;

      navItems.forEach(function (btn) {
        var target = btn.getAttribute("data-section");
        btn.classList.toggle("active", target === sectionName);
      });

      sections.forEach(function (section) {
        var target = section.getAttribute("data-section");
        if (target === sectionName) {
          section.classList.remove("d-none");
        } else {
          section.classList.add("d-none");
        }
      });

      if (modalTitle) {
        var activeBtn = modal.querySelector(
          '.edit-profile-nav-item[data-section="' + sectionName + '"]'
        );
        if (activeBtn) {
          modalTitle.textContent = activeBtn.textContent.trim();
        }
      }

      if (sectionName === "password") {
        if (profileForm) profileForm.classList.add("d-none");
        if (passwordForm) passwordForm.classList.remove("d-none");
      } else {
        if (profileForm) profileForm.classList.remove("d-none");
        if (passwordForm) passwordForm.classList.add("d-none");
      }

      updateButtons();
    }

    navItems.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var sectionName = btn.getAttribute("data-section");
        if (!sectionName) return;
        activateSection(sectionName);
      });
    });

    avatarInputs.forEach(function (input) {
      input.addEventListener("change", function () {
        var file = input.files && input.files[0];
        if (file) {
          if (removeAvatarInput) {
            removeAvatarInput.value = removeAvatarInput.defaultValue || "";
          }
          var reader = new FileReader();
          reader.onload = function (e) {
            showAvatarImage(e.target.result || initialAvatarUrl);
            if (removeAvatarBtn) removeAvatarBtn.classList.remove("d-none");
            recomputeDirty();
            updateButtons();
          };
          reader.readAsDataURL(file);
        } else {
          if (removeAvatarInput && removeAvatarInput.value !== removeAvatarInput.defaultValue) {
            removeAvatarInput.value = removeAvatarInput.defaultValue;
          }
          recomputeDirty();
          updateButtons();
        }
      });
    });

    avatarEditButtons.forEach(function (btn) {
      btn.addEventListener("click", function (event) {
        event.preventDefault();
        if (primaryAvatarInput) {
          primaryAvatarInput.click();
        }
      });
    });

    if (removeAvatarBtn) {
      removeAvatarBtn.addEventListener("click", function (event) {
        event.preventDefault();
        avatarInputs.forEach(function (input) {
          input.value = "";
        });
        if (removeAvatarInput) {
          removeAvatarInput.value = "true";
          removeAvatarInput.defaultValue = removeAvatarInput.defaultValue || "false";
        }
        showAvatarInitial();
        profileDirty = true;
        recomputeDirty();
        updateButtons();
        if (profileSubmit) profileSubmit.classList.remove("d-none");
      });
    }

    function wireDirtyTracking(form) {
      if (!form) return;
      form.querySelectorAll("input, textarea, select").forEach(function (el) {
        el.addEventListener("input", function () {
          recomputeDirty();
          updateButtons();
        });
        el.addEventListener("change", function () {
          recomputeDirty();
          updateButtons();
        });
      });
    }

    wireDirtyTracking(profileForm);
    wireDirtyTracking(passwordForm);

    recomputeDirty();
    updateButtons();
  })();
</script>
