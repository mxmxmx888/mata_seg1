<script>
  (function () {
    var modal = document.getElementById("editProfileModal");
    if (!modal) return;

    var navItems = modal.querySelectorAll(".edit-profile-nav-item");
    var sections = modal.querySelectorAll(".edit-profile-section");
    var profileForm = modal.querySelector("#editProfileForm");
    var passwordForm = modal.querySelector("#passwordForm");
    var profileSubmit = modal.querySelector(".edit-profile-submit-profile");
    var passwordSubmit = modal.querySelector(".edit-profile-submit-password");
    var modalTitle = modal.querySelector("#editProfileModalLabel");
    var avatarInputs = modal.querySelectorAll("[data-avatar-input]");
    var avatarEditButtons = modal.querySelectorAll("[data-avatar-edit]");
    var primaryAvatarInput = avatarInputs.length ? avatarInputs[0] : null;
    var removeAvatarInput = modal.querySelector("[data-remove-avatar-input]");
    var removeAvatarBtn = modal.querySelector("[data-remove-avatar]");
    var avatarImages = modal.querySelectorAll("[data-avatar-image]");
    var avatarInitials = modal.querySelectorAll("[data-avatar-initial]");
    var privacyToggle = modal.querySelector("[data-privacy-toggle]");
    var privacyButton = modal.querySelector("[data-privacy-button]");
    var privacyStatus = modal.querySelector("[data-privacy-status]");
    var privacyInput = modal.querySelector("input[name='is_private']");
    var initialAvatarUrl = "";
    if (removeAvatarInput && !removeAvatarInput.defaultValue) {
      removeAvatarInput.defaultValue = removeAvatarInput.value || "false";
    }
    avatarImages.forEach(function (img) {
      if (!initialAvatarUrl && img.getAttribute("src")) {
        initialAvatarUrl = img.getAttribute("src");
      }
    });
    var currentSection = "profile";
    var profileDirty = false;
    var passwordDirty = false;

    function showAvatarInitial() {
      avatarImages.forEach(function (img) {
        img.classList.add("d-none");
        img.removeAttribute("src");
      });
      avatarInitials.forEach(function (span) {
        span.classList.remove("d-none");
      });
    }

    function showAvatarImage(url) {
      if (!url) return;
      avatarImages.forEach(function (img) {
        img.src = url;
        img.classList.remove("d-none");
      });
      avatarInitials.forEach(function (span) {
        span.classList.add("d-none");
      });
    }

    function recomputeDirty() {
      profileDirty = false;
      passwordDirty = false;

      if (profileForm) {
        profileForm.querySelectorAll("input, textarea, select").forEach(function (el) {
          var isCheckbox = el.type === "checkbox" || el.type === "radio";
          var changed = isCheckbox
            ? el.checked !== el.defaultChecked
            : el.value !== el.defaultValue;
          if (changed) profileDirty = true;
        });
      }

      if (passwordForm) {
        passwordForm.querySelectorAll("input, textarea, select").forEach(function (el) {
          var isCheckbox = el.type === "checkbox" || el.type === "radio";
          var changed = isCheckbox
            ? el.checked !== el.defaultChecked
            : el.value !== el.defaultValue;
          if (changed) passwordDirty = true;
        });
      }
    }

    function syncPrivacyUI() {
      if (!privacyInput || !privacyButton || !privacyStatus) return;
      var isPrivate = privacyInput.checked;
      privacyStatus.textContent = isPrivate ? "Private" : "Public";
      privacyButton.textContent = isPrivate ? "Make public" : "Make private";
    }

    if (privacyButton && privacyInput) {
      privacyButton.addEventListener("click", function () {
        privacyInput.checked = !privacyInput.checked;
        syncPrivacyUI();
        recomputeDirty();
        updateButtons();
      });
      syncPrivacyUI();
    }

    function updateButtons() {
      if (currentSection === "password") {
        if (profileSubmit) profileSubmit.classList.add("d-none");
        if (passwordSubmit) {
          passwordSubmit.classList.toggle("d-none", !passwordDirty);
        }
      } else {
        if (passwordSubmit) passwordSubmit.classList.add("d-none");
        if (profileSubmit) {
          profileSubmit.classList.toggle("d-none", !profileDirty);
        }
      }
    }

    function activateSection(sectionName) {
      currentSection = sectionName;

      navItems.forEach(function (btn) {
        var target = btn.getAttribute("data-section");
        btn.classList.toggle("active", target === sectionName);
      });

      sections.forEach(function (section) {
        var target = section.getAttribute("data-section");
        if (target === sectionName) {
          section.classList.remove("d-none");
        } else {
          section.classList.add("d-none");
        }
      });

      if (modalTitle) {
        var activeBtn = modal.querySelector(
          '.edit-profile-nav-item[data-section="' + sectionName + '"]'
        );
        if (activeBtn) {
          modalTitle.textContent = activeBtn.textContent.trim();
        }
      }

      if (sectionName === "password") {
        if (profileForm) profileForm.classList.add("d-none");
        if (passwordForm) passwordForm.classList.remove("d-none");
      } else {
        if (profileForm) profileForm.classList.remove("d-none");
        if (passwordForm) passwordForm.classList.add("d-none");
      }

      updateButtons();
    }

    navItems.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var sectionName = btn.getAttribute("data-section");
        if (!sectionName) return;
        activateSection(sectionName);
      });
    });

    avatarInputs.forEach(function (input) {
      input.addEventListener("change", function () {
        var file = input.files && input.files[0];
        if (file) {
          if (removeAvatarInput) {
            removeAvatarInput.value = removeAvatarInput.defaultValue || "";
          }
          var reader = new FileReader();
          reader.onload = function (e) {
            showAvatarImage(e.target.result || initialAvatarUrl);
            if (removeAvatarBtn) removeAvatarBtn.classList.remove("d-none");
            recomputeDirty();
            updateButtons();
          };
          reader.readAsDataURL(file);
        } else {
          if (removeAvatarInput && removeAvatarInput.value !== removeAvatarInput.defaultValue) {
            removeAvatarInput.value = removeAvatarInput.defaultValue;
          }
          recomputeDirty();
          updateButtons();
        }
      });
    });

    avatarEditButtons.forEach(function (btn) {
      btn.addEventListener("click", function (event) {
        event.preventDefault();
        if (primaryAvatarInput) {
          primaryAvatarInput.click();
        }
      });
    });

    if (removeAvatarBtn) {
      removeAvatarBtn.addEventListener("click", function (event) {
        event.preventDefault();
        avatarInputs.forEach(function (input) {
          input.value = "";
        });
        if (removeAvatarInput) {
          removeAvatarInput.value = "true";
          removeAvatarInput.defaultValue = removeAvatarInput.defaultValue || "false";
        }
        showAvatarInitial();
        profileDirty = true;
        recomputeDirty();
        updateButtons();
        if (profileSubmit) profileSubmit.classList.remove("d-none");
      });
    }

    function wireDirtyTracking(form) {
      if (!form) return;
      form.querySelectorAll("input, textarea, select").forEach(function (el) {
        el.addEventListener("input", function () {
          recomputeDirty();
          updateButtons();
        });
        el.addEventListener("change", function () {
          recomputeDirty();
          updateButtons();
        });
      });
    }

    wireDirtyTracking(profileForm);
    wireDirtyTracking(passwordForm);

    recomputeDirty();
    updateButtons();
  })();
</script>

