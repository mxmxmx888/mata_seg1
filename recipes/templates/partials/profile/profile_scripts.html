<script>
  (function () {
    if (window.__profileScriptsInitialized) return;
    window.__profileScriptsInitialized = true;

    function initProfileScripts() {
      var usingBootstrap = !!(window.bootstrap && window.bootstrap.Modal);
      var fallbackBackdrop = null;
      var currentFallbackModal = null;

      function ensureBackdrop() {
        if (fallbackBackdrop) return fallbackBackdrop;
        var el = document.createElement("div");
        el.className = "modal-backdrop fade custom-modal-backdrop";
        document.body.appendChild(el);
        fallbackBackdrop = el;
        return el;
      }

      function showFallbackModal(modalEl) {
        currentFallbackModal = modalEl;
        var backdrop = ensureBackdrop();
        backdrop.style.display = "block";
        window.setTimeout(function () {
          backdrop.classList.add("show");
        }, 0);

        modalEl.classList.add("show");
        modalEl.style.display = "block";
        modalEl.removeAttribute("aria-hidden");

        document.body.classList.add("modal-open");
        document.body.style.overflow = "hidden";

        backdrop.onclick = function () {
          hideFallbackModal();
        };
      }

      function hideFallbackModal() {
        if (!currentFallbackModal) return;

        currentFallbackModal.classList.remove("show");
        currentFallbackModal.style.display = "none";
        currentFallbackModal.setAttribute("aria-hidden", "true");

        if (fallbackBackdrop) {
          fallbackBackdrop.classList.remove("show");
          fallbackBackdrop.style.display = "none";
          fallbackBackdrop.onclick = null;
        }

        document.body.classList.remove("modal-open");
        document.body.style.overflow = "";
        currentFallbackModal = null;
      }

      function wireFollowModal(buttonSelector, modalId) {
        var buttons = document.querySelectorAll(buttonSelector);
        var modalEl = document.getElementById(modalId);
        if (!buttons.length || !modalEl) return;

        if (!usingBootstrap) {
          modalEl.addEventListener("click", function (event) {
            if (event.target === modalEl) {
              hideFallbackModal();
            }
          });

          var closeBtn = modalEl.querySelector("[data-bs-dismiss='modal'], .btn-close");
          if (closeBtn) {
            closeBtn.addEventListener("click", function (event) {
              event.preventDefault();
              hideFallbackModal();
            });
          }
        }

        buttons.forEach(function (btn) {
          btn.addEventListener("click", function (event) {
            event.preventDefault();
            if (usingBootstrap) {
              var instance = window.bootstrap.Modal.getOrCreateInstance(modalEl);
              instance.show();
            } else {
              showFallbackModal(modalEl);
            }
          });
        });
      }

      wireFollowModal('[data-bs-target="#followersModal"]', "followersModal");
      wireFollowModal('[data-bs-target="#followingModal"]', "followingModal");
      wireFollowModal('[data-bs-target="#closeFriendsModal"]', "closeFriendsModal");
      wireFollowModal('[data-bs-target="#editProfileModal"]', "editProfileModal");

      document.querySelectorAll(".follow-toggle-form").forEach(function (form) {
        var btn = form.querySelector(".follow-toggle-btn");
        if (!btn) return;

        var followingLabel = btn.getAttribute("data-label-following") || "Following";
        var unfollowLabel = btn.getAttribute("data-label-unfollow") || "Unfollow";

        btn.addEventListener("mouseenter", function () {
          btn.textContent = unfollowLabel;
        });

        btn.addEventListener("mouseleave", function () {
          btn.textContent = followingLabel;
        });

        form.addEventListener("submit", function (event) {
          event.preventDefault();

          var url = form.getAttribute("action");
          if (!url) return;

          var formData = new FormData(form);

          fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
            credentials: "same-origin",
          }).then(function (response) {
            if (response.ok) {
              var li = form.closest("li");
              if (li) {
                li.remove();
              }
            }
          }).catch(function () {
            form.submit();
          });
        });
      });

      var searchInput = document.getElementById("closeFriendsSearch");
      var list = document.getElementById("closeFriendsList");
      if (searchInput && list) {
        var items = list.querySelectorAll(".close-friend-item");
        searchInput.addEventListener("input", function () {
          var term = searchInput.value.trim().toLowerCase();
          items.forEach(function (item) {
            var name = item.getAttribute("data-name") || "";
            var match = !term || name.indexOf(term) !== -1;
            item.style.display = match ? "" : "none";
          });
        });
      }

      function attachAjaxModalForms(modalId, onSuccess) {
        var modalEl = document.getElementById(modalId);
        if (!modalEl) return;

        modalEl.querySelectorAll("form").forEach(function (form) {
          if (form.dataset.ajaxBound === "1") return;
          form.dataset.ajaxBound = "1";

          form.addEventListener("submit", function (event) {
            event.preventDefault();
            var url = form.getAttribute("action");
            if (!url) return;

            var formData = new FormData(form);

            fetch(url, {
              method: "POST",
              body: formData,
              headers: { "X-Requested-With": "XMLHttpRequest" },
              credentials: "same-origin",
            })
              .then(function (response) {
                if (!response.ok) {
                  throw new Error("Request failed");
                }
                return response.json().catch(function () {
                  return {};
                });
              })
              .then(function (payload) {
                if (typeof onSuccess === "function") {
                  onSuccess({ form: form, url: url, payload: payload || {} });
                }
              })
              .catch(function () {
                form.submit();
              });
          });
        });
      }

      attachAjaxModalForms("closeFriendsModal", function (ctx) {
        var form = ctx.form;
        var url = ctx.url;
        var btn = form.querySelector("button");
        var isAdd = url.indexOf("/add/") !== -1;
        var toggled = isAdd
          ? url.replace("/add/", "/remove/")
          : url.replace("/remove/", "/add/");
        form.setAttribute("action", toggled);
        if (btn) {
          btn.textContent = isAdd ? "Remove" : "Add";
        }
      });

      attachAjaxModalForms("followersModal", function (ctx) {
        var li = ctx.form.closest("li");
        if (li) li.remove();
      });

      attachAjaxModalForms("followingModal", function (ctx) {
        var li = ctx.form.closest("li");
        if (li) li.remove();
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initProfileScripts);
    } else {
      initProfileScripts();
    }
  })();
</script>
