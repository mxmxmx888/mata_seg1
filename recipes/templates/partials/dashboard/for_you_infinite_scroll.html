{% if not has_search and for_you_posts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('forYou-grid');
    const sentinel = document.getElementById('forYou-sentinel');
    const loadingEl = document.getElementById('forYou-loading');
    if (!container || !sentinel) return;

    const columns = Array.from(container.querySelectorAll('.feed-masonry-column'));
    if (!columns.length) return;

    const LIMIT = 12;
    let offset = container.querySelectorAll('.my-recipe-card').length;
    let loading = false;
    let hasMore = offset >= LIMIT;

    function setLoading(state) {
      loading = state;
      if (!loadingEl) return;
      if (state) {
        loadingEl.classList.remove('d-none');
      } else {
        loadingEl.classList.add('d-none');
      }
    }

    function appendHtmlToColumns(html) {
      if (!html) return;
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const cards = Array.from(temp.querySelectorAll('.my-recipe-card'));

      cards.forEach(function (card) {
        let target = columns[0];
        for (let i = 1; i < columns.length; i += 1) {
          if (columns[i].offsetHeight < target.offsetHeight) {
            target = columns[i];
          }
        }
        target.appendChild(card);
      });
    }

    function loadMoreForYou() {
      if (loading || !hasMore) return;
      setLoading(true);

      const url = new URL(window.location.href);
      url.searchParams.set('for_you_ajax', '1');
      url.searchParams.set('for_you_offset', String(offset));

      fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function (data) {
          if (data && data.html) {
            appendHtmlToColumns(data.html);
            offset += data.count || 0;
            hasMore = Boolean(data.has_more);
          } else {
            hasMore = false;
          }
          setLoading(false);
        })
        .catch(function () {
          setLoading(false);
        });
    }

    const observer = 'IntersectionObserver' in window
      ? new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              loadMoreForYou();
            }
          });
        }, { rootMargin: '600px 0px' })
      : null;

    if (observer) {
      observer.observe(sentinel);
    } else {
      window.addEventListener('scroll', function () {
        if (loading || !hasMore) return;
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 300;
        if (scrollPosition >= threshold) {
          loadMoreForYou();
        }
      });
    }
  });
</script>
{% endif %}
