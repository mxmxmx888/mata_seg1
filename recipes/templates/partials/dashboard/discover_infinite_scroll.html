{% if has_search and popular_has_next %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('discover-grid');
    if (!container) return;

    const columns = Array.from(
      container.querySelectorAll('.feed-masonry-column')
    );
    if (!columns.length) return;

    let page = 1;
    let loading = false;
    let hasNext = {{ popular_has_next|yesno:"true,false" }};

    function appendHtmlToColumns(html) {
      if (!html) return;
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const cards = Array.from(
        temp.querySelectorAll('.my-recipe-card')
      );

      cards.forEach(function (card) {
        let target = columns[0];
        for (let i = 1; i < columns.length; i += 1) {
          if (columns[i].offsetHeight < target.offsetHeight) {
            target = columns[i];
          }
        }
        target.appendChild(card);
      });
    }

    function loadMoreDiscover() {
      if (loading || !hasNext) return;
      loading = true;

      page += 1;
      const url = new URL(window.location.href);
      url.searchParams.set('page', String(page));
      url.searchParams.set('ajax', '1');

      fetch(url.toString(), {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function (data) {
          if (data && data.html) {
            appendHtmlToColumns(data.html);
          }
          hasNext = Boolean(data && data.has_next);
          loading = false;
        })
        .catch(function () {
          loading = false;
        });
    }

    window.addEventListener('scroll', function () {
      if (loading || !hasNext) return;

      const scrollPosition = window.innerHeight + window.scrollY;
      const threshold = document.body.offsetHeight - 300;

      if (scrollPosition >= threshold) {
        loadMoreDiscover();
      }
    });
  });
</script>
{% endif %}
