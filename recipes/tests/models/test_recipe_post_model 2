from unittest.mock import patch
from django.test import TestCase
from recipes.models import User, RecipePost
from recipes.models.recipe_post import RecipeImage


class RecipePostModelTestCase(TestCase):
    fixtures = [
        "recipes/tests/fixtures/default_user.json",
        "recipes/tests/fixtures/other_users.json",
    ]

    def setUp(self):
        self.author = User.objects.get(username="@johndoe")

    def test_str_returns_title(self):
        post = RecipePost.objects.create(author=self.author, title="Tacos", description="d")
        self.assertEqual(str(post), "Tacos")

    def test_primary_image_uses_related_image(self):
        post = RecipePost(author=self.author, title="Pizza", description="d")
        fake_img = type("FakeImg", (), {"image": type("Img", (), {"url": "fake-url"})()})
        def fake_first(_self):
            return fake_img
        fake_mgr = type("FakeMgr", (), {"first": fake_first})()
        with patch.object(RecipePost, "images", fake_mgr):
            self.assertEqual(post.primary_image_url, "fake-url")

    def test_primary_image_falls_back_to_field(self):
        post = RecipePost(author=self.author, title="Toast", description="d", image="http://x.test/img.png")
        self.assertEqual(post.primary_image_url, "http://x.test/img.png")

    def test_primary_image_none_when_missing(self):
        post = RecipePost(author=self.author, title="Soup", description="d")
        self.assertIsNone(post.primary_image_url)

    def test_primary_image_handles_value_error(self):
        class BadImg:
            def __init__(self):
                self.image = self
            @property
            def url(self):
                raise ValueError("bad path")
        post = RecipePost(author=self.author, title="Cake", description="d")
        fake_mgr = type("FakeMgr", (), {"first": lambda self: BadImg()})()
        with patch.object(RecipePost, "images", property(lambda self: fake_mgr)):
            self.assertIsNone(post.primary_image_url)

    def test_primary_image_prefers_related_none_then_field(self):
        class NoImg:
            image = None
        fake_mgr = type("FakeMgr", (), {"first": lambda self: NoImg()})()
        post = RecipePost(author=self.author, title="Cake2", description="d", image="http://img")
        with patch.object(RecipePost, "images", property(lambda self: fake_mgr)):
            self.assertEqual(post.primary_image_url, "http://img")

    def test_primary_image_none_when_manager_missing(self):
        post = RecipePost(author=self.author, title="Blank", description="d")
        with patch.object(RecipePost, "images", property(lambda self: None)):
            self.assertIsNone(post.primary_image_url)

    def test_recipe_image_str(self):
        post = RecipePost.objects.create(author=self.author, title="Pic", description="d")
        image = RecipeImage(recipe_post=post)
        self.assertEqual(str(image), f"Image for {post.id}")
